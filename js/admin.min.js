var adminParams,adminPreloadSearch,createDuplicateTaxon,createNewTaxon,deleteTaxon,fetchEditorDropdownContent,fillEmptyCommonName,handleDeprecatedInput,handleDragDropImage,licenseHelper,loadAdminUi,loadModalTaxonEditor,lookupEditorSpecies,newColumnHelper,prefetchEditorDropdowns,renderAdminSearchResults,renderDeprecatedFromDatabase,saveEditorEntry,verifyLoginCredentials,indexOf=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};adminParams={},adminParams.apiTarget="admin-api.php",adminParams.adminPageUrl="https://mammaldiversity.org/admin-page.html",adminParams.loginDir="admin/",adminParams.loginApiTarget=adminParams.loginDir+"async_login_handler.php",loadAdminUi=function(){var a;console.log("Loading admin UI");try{verifyLoginCredentials(function(a){var b,c,d,e;return c=uri.domain+"_name",b=uri.domain+"_fullname",adminParams.cookieName=c,adminParams.cookieFullName=b,d='<h3 class="col-xs-12">\n  Welcome, '+$.cookie(c)+'\n  <span id="pib-wrapper-settings" class="pib-wrapper" data-toggle="tooltip" title="User Settings" data-placement="bottom">\n    <paper-icon-button icon=\'settings-applications\' class=\'click\' data-url=\''+a.login_url+'\'></paper-icon-button>\n  </span>\n  <span id="pib-wrapper-exit-to-app" class="pib-wrapper" data-toggle="tooltip" title="Go to SADB app" data-placement="bottom">\n    <paper-icon-button icon=\'exit-to-app\' class=\'click\' data-url=\''+uri.urlString+"' id=\"app-linkout\"></paper-icon-button>\n  </span>\n</h3>\n<div id='admin-actions-block' class=\"col-xs-12\">\n  <div class='bs-callout bs-callout-info'>\n    <p>Please be patient while the administrative interface loads.</p>\n  </div>\n</div>",$("main #main-body").html(d),bindClicks(),e='<form id="admin-search-form" onsubmit="event.preventDefault()" class="row">\n  <div>\n    <paper-input label="Search for species" id="admin-search" name="admin-search" required autofocus floatingLabel class="col-xs-7 col-sm-8"></paper-input>\n    <paper-fab id="do-admin-search" icon="search" raisedButton class="asm-blue"></paper-fab>\n    <paper-fab id="do-admin-add" icon="add" raisedButton class="asm-blue"></paper-fab>\n  </div>\n</form>\n<div id=\'search-results\' class="row"></div>',$("#admin-actions-block").html("<div class='col-xs-12'>"+e+"</div>"),$("#admin-search-form").submit(function(a){return a.preventDefault()}),$("#admin-search").keypress(function(a){if(13===a.which)return renderAdminSearchResults()}),$("#do-admin-search").click(function(){return renderAdminSearchResults()}),$("#do-admin-add").click(function(){return createNewTaxon()}),bindClickTargets(),console.info("Successfully validated user"),!1})}catch(b){a=b,console.error("Couldn't check status - "+a.message),console.warn(a.stack),$("main #main-body").html("<div class='bs-callout bs-callout-danger col-xs-12'><h4>Application Error</h4><p>There was an error in the application. Please refresh and try again. If this persists, please contact administration.</p></div>")}return!1},verifyLoginCredentials=function(a){var b,c,d,e,f;try{d=$.cookie(uri.domain+"_auth"),f=$.cookie(uri.domain+"_secret"),e=$.cookie(uri.domain+"_link")}catch(a){c=a,console.warn("Unable to verify login credentials: "+c.message),console.debug(c.stack)}return b="hash="+d+"&secret="+f+"&dblink="+e,$.post(adminParams.loginApiTarget,b,"json").done(function(b){var c;return console.log("Server called back from login credential verification",b),!0!==b.status?($(".logged-in-values").remove(),"function"==typeof a&&!0!==_asm.inhibitRedirect?isNull(b.login_url)?$("main #main-body").html("<div class='bs-callout-danger bs-callout col-xs-12'><h4>Couldn't verify login</h4><p>There's currently a server problem. Try back again soon.</p><p>The server said:</p><code>"+b.error+"</code></div>"):goTo(b.login_url):console.log("Login credentials checked -- not logged in")):($(".logged-in-values").removeAttr("hidden"),c=uri.domain+"_fullname",$("header .fill-user-fullname").text($.cookie(c)),"function"==typeof a?a(b):void 0)}).fail(function(a,b){return $("main #main-body").html("<div class='bs-callout-danger bs-callout col-xs-12'><h4>Couldn't verify login</h4><p>There's currently a server problem. Try back again soon.</p></div>"),console.log(a,b),!1}),!1},renderAdminSearchResults=function(a){var b,c,d,e;return null==a&&(a="#search-results"),e=$("#admin-search").val(),isNull(e)?(toastStatusMessage("Please enter a search term"),!1):(animateLoad(),$("#admin-search").blur(),e=e.replace(/\./g,""),e=prepURI(e.toLowerCase()),b="q="+e+"&loose=true",c=Base64.encodeURI(e),d=uri.urlString+"#"+c,$("#app-linkout").attr("data-url",d),$.get(searchParams.targetApi,b,"json").done(function(b){var c,d,e,f,g,h,i;return!0!==b.status||0===b.count?(stopLoadError(),isNull(b.human_error)?toastStatusMessage("Your search returned no results. Please try again."):toastStatusMessage(b.human_error),!1):(e=b.result,f="",h="<table id='cndb-result-list' class='table table-striped table-hover'>\n\t<tr class='cndb-row-headers'>",g="</table>",i=toInt(b.count)-1,d=null,c=0,$.each(e,function(b,e){var j,k,l,m;if(0===toInt(b)&&(k=0,h+="\n\x3c!-- Table Headers - "+Object.size(e)+" entries --\x3e",$.each(e,function(a,b){var f,g;if(g=a.replace(/_/g," "),"genus"!==a&&"species"!==a&&"subspecies"!==a||(h+="\n\t\t<th class='text-center'>"+g+"</th>",c++),++k===Object.size(e))return h+="\n\t\t<th class='text-center'>Edit</th>",c++,h+="\n\t\t<th class='text-center'>Delete</th>\n\t</tr>",c++,h+="\n\x3c!-- End Table Headers --\x3e",console.log("Got "+c+" display columns."),f=roundNumber(12/c,0),d="col-md-"+f})),m=e.genus.trim()+"+"+e.species.trim(),isNull(e.subspecies)||(m=m+"+"+e.subspecies.trim()),j="\n\t<tr id='cndb-row"+b+"' class='cndb-result-entry' data-taxon=\""+m+'">',l=0,$.each(e,function(a,c){return!!isNull(e.genus)||("genus"!==a&&"species"!==a&&"subspecies"!==a||(j+="\n\t\t<td id='"+a+"-"+b+"' class='"+a+" "+d+"'>"+c+"</td>"),l++,l===Object.size(e)?(j+="\n\t\t<td id='edit-"+b+"' class='edit-taxon "+d+" text-center'><paper-icon-button icon='image:edit' class='edit' data-taxon='"+m+"'></paper-icon-button></td>",j+="\n\t\t<td id='delete-"+b+"' class='delete-taxon "+d+" text-center'><paper-icon-button icon='delete' class='delete-taxon-button fadebg' data-taxon='"+m+"' data-database-id='"+e.id+"'></paper-icon-button></td>",j+="\n\t</tr>",f+=j):void 0)}),toInt(b)===i)return f=h+f+g,$(a).html(f),console.log("Processed "+(toInt(b)+1)+" rows"),$(".edit").click(function(){var a;return a=$(this).attr("data-taxon"),lookupEditorSpecies(a)}),$(".delete-taxon-button").click(function(){var a;return $(this).attr("data-taxon"),a=$(this).attr("data-database-id"),deleteTaxon(a)}),stopLoad()}))}).fail(function(a,b){var c;return console.error("There was an error performing the search"),console.warn(a,c,a.statusText),c=a.status+" - "+a.statusText,$("#search-status").attr("text","Couldn't execute the search - "+c),$("#search-status")[0].show(),stopLoadError()}))},fetchEditorDropdownContent=function(a,b,c,d){var e;return null==a&&(a="simple_linnean_goup"),null==c&&(c=!0),null==d&&(d=!0),"object"!=typeof("undefined"!=typeof _asm&&null!==_asm?_asm.dropdownPopulation:void 0)&&("object"!=typeof _asm&&(window._asm={}),_asm.dropdownPopulation={}),e=a.replace(/\_/g,"-"),isNull(b)&&(b=a.replace(/\_/g," ").toTitleCase()),_asm.dropdownPopulation[a]={html:'<paper-input label="'+b+'" id="edit-'+e+'" name="edit-'+e+'" class="'+a+'" floatingLabel></paper-input>'},$.get(searchParams.targetApi,"get_unique=true&col="+a,"json").done(function(f){var g,h,i,j,k,l,m;if(!0!==f.status)return console.warn("Didn't get a valid set of values for column '"+a+"': "+f.error),!1;for(m=Object.toArray(f.values),i="",j=0,h=m.length;j<h;j++)l=m[j],i+='<paper-item data-value="'+l+'" data-column="'+a+'">'+l+"</paper-item>\n";return g='<section class="row filled-editor-dropdown">\n<div class="col-xs-9">\n  <paper-dropdown-menu label="'+b+'" id="edit-'+e+'" name="edit-'+e+'" class="'+a+'" data-column="'+a+'">\n    <paper-listbox class="dropdown-content">\n      '+i+'\n    </paper-listbox>\n  </paper-dropdown-menu>\n</div>\n<div class="col-xs-3">\n  <paper-icon-button class="add-col-value" data-column='+a+' icon="icons:add-circle" title="Add new '+b+'" data-toggle="tooltip"></paper-icon-button>\n</div>\n</section>',d&&(_asm.dropdownPopulation[a]={values:m,html:g,selector:"#edit-"+e}),c&&(k="#edit-"+e,$(k).exists()&&$(k).replaceWith(g)),!1}).fail(function(c,d){return console.warn("Unable to get dropdown content for '"+a+"'"),console.warn(c,d),_asm.dropdownPopulation[a]={html:'<paper-input label="'+b+'" id="edit-'+e+'" name="edit-'+e+'" class="'+a+'" floatingLabel></paper-input>'}}),!1},licenseHelper=function(a){return null==a&&(a="#edit-image-license-dialog"),$(a).unbind(),_asm._setLicenseDialog=function(b){var c,d,e,f,g;return f=$(b).attr("data-column"),isNull(f)?(console.error("Unable to show dialog -- invalud column designator"),!1):(console.debug("Add column fired -- target is "+f),$("paper-dialog#set-license-value").remove(),c=$(a).attr("data-license-name"),d=$(a).attr("data-license-url"),e='<paper-dialog id="set-license-value" data-column="'+f+'" modal>\n  <h2>Set License</h2>\n  <paper-dialog-scrollable>\n    <paper-input class="new-license-name license-field" label="License Name" floatingLabel autofocus value="'+c+'" required autovalidate></paper-input>\n    <paper-input class="new-license-url license-field" label="License URL" floatingLabel value="'+d+'" required autovalidate></paper-input>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Cancel</paper-button>\n    <paper-button class="add-value">Set</paper-button>\n  </div>\n</paper-dialog>',$("body").append(e),g="((?:https?)://(?:(?:(?:[0-9]+\\.){3}[0-9]+|(?:[0-9a-f]+:){6,8}|(?:[\\w~\\-]{2,}\\.)+[\\w]{2,}|localhost))/?(?:[\\w~\\-]*/?)*(?:(?:\\.\\w+)?(?:\\?(?:\\w+=\\w+&?)*)?))(?:#[\\w~\\-]+)?",p$("paper-input.new-license-url").pattern=g,p$("paper-input.new-license-url").errorMessage="This must be a valid URL",p$("paper-input.new-license-name").errorMessage="This cannot be empty",_asm._updateLicense=function(){var a;return $("paper-icon-button#edit-image-license-dialog").attr("data-license-name",p$("paper-input.new-license-name").value).attr("data-license-url",p$("paper-input.new-license-url").value),a=p$("paper-input.new-license-name").value+" @ "+p$("paper-input.new-license-url").value,p$("#edit-image-license").value=a,$("#edit-image-license").attr("data-license-name",p$("paper-input.new-license-name").value).attr("data-license-url",p$("paper-input.new-license-url").value),p$("#set-license-value").close(),!1},$("#set-license-value paper-button.add-value").click(function(){var a,b,c,d,e;for(b=!0,e=$("#set-license-value .license-field"),d=0,c=e.length;d<c;d++)a=e[d],p$(a).validate(),p$(a).invalid&&(b=!1);if(!b)return!1;console.debug("isReady",b);try{_asm._updateLicense.debounce(50)}catch(a){console.warn("Couldn't debounce save new col call"),stopLoadError("There was a problem saving this data")}return!1}),$("#set-license-value").on("iron-overlay-opened",function(){return p$(this).refit(),delay(100,function(a){return function(){return p$(a).refit()}}(this))}),p$("#set-license-value").open(),!1)},$(a).click(function(){return console.debug("Set License clicked"),_asm._setLicenseDialog.debounce(50,null,null,this),!1})},newColumnHelper=function(a){return null==a&&(a=".add-col-value"),$(a).unbind(),_asm._addColumnDialog=function(a){var b,c;return c=$(a).attr("data-column"),isNull(c)?(console.error("Unable to show dialog -- invalud column designator"),!1):(console.debug("Add column fired -- target is "+c),$("paper-dialog#add-column-value").remove(),b='<paper-dialog id="add-column-value" data-column="'+c+'" modal>\n  <h2>Add New <code>'+c.replace(/[\_-]/g," ")+'</code> Value</h2>\n  <paper-dialog-scrollable>\n    <paper-input class="new-col-value" label="Data Value" floatingLabel autofocus></paper-input>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Cancel</paper-button>\n    <paper-button class="add-value">Add</paper-button>\n  </div>\n</paper-dialog>',$("body").append(b),_asm._saveNewCol=function(){var a,b,d;return d=$("#add-column-value paper-input.new-col-value").val(),console.log("Going to test and add '"+d+"'"),indexOf.call(_asm.dropdownPopulation[c].values,d)>=0?(console.warn("Invalid value: already exists"),p$("#add-column-value paper-input.new-col-value").errorMessage="This value already exists",p$("#add-column-value paper-input.new-col-value").invalid=!0,p$("#add-column-value").refit(),!1):(a=document.createElement("paper-item"),a.setAttribute("data-value",d),a.setAttribute("data-column",c),a.textContent=d,'<paper-item data-value="'+d+'" data-column="'+c+'">'+d+"</paper-item>\n",_asm.dropdownPopulation[c].values.push(d),_asm.dropdownPopulation[c].values.sort(),b=p$("paper-dropdown-menu[data-column='"+c+"'] paper-listbox"),Polymer.dom(b).appendChild(a),delay(250,function(){return $("paper-dropdown-menu[data-column='"+c+"']").polymerSelected(d,!0),p$("#add-column-value").close()}),!1)},$("#add-column-value paper-button.add-value").click(function(){try{_asm._saveNewCol.debounce(50)}catch(a){console.warn("Couldn't debounce save new col call"),stopLoadError("There was a problem saving this data")}return!1}),$("#add-column-value paper-input").keyup(function(a){if(13===(a.keyCode?a.keyCode:a.which))try{_asm._saveNewCol.debounce(50)}catch(a){console.warn("Couldn't debounce save new col call"),stopLoadError("There was a problem saving this data")}return!1}),p$("#add-column-value").open(),!1)},$(a).click(function(){return console.debug("Add column clicked"),_asm._addColumnDialog.debounce(50,null,null,this),!1})},prefetchEditorDropdowns=function(){var a,b,c;c={major_type:"Clade (eg., boreoeutheria)",major_subtype:"Sub-Clade (eg., euarchontoglires)",linnean_order:null,linnean_family:null,simple_linnean_group:"Common Group (eg., metatheria)",simple_linnean_subgroup:"Common type (eg., bat)"};for(a in c)b=c[a],fetchEditorDropdownContent(a,b);return!1},window.prefetchEditorDropdowns=prefetchEditorDropdowns,loadModalTaxonEditor=function(a,b){var c,d,e,f,g;null==a&&(a=""),null==b&&(b="Save"),g=new Date,f=g.toISOString().split("T")[0],d='<paper-input label="Genus" id="edit-genus" name="edit-genus" class="genus" floatingLabel></paper-input>\n<paper-input label="Species" id="edit-species" name="edit-species" class="species" floatingLabel></paper-input>\n<paper-input label="Subspecies" id="edit-subspecies" name="edit-subspecies" class="subspecies" floatingLabel></paper-input>\n<paper-input label="Common Name" id="edit-common-name" name="edit-common-name"  class="common_name" floatingLabel></paper-input>\n<paper-input label="Common Name Source" id="edit-common-name-source" name="edit-common-name-source"  class="common_name_source" floatingLabel readonly></paper-input>\n<paper-input label="Deprecated Scientific Names" id="edit-deprecated-scientific" name="edit-depreated-scientific" floatingLabel aria-describedby="deprecatedHelp"></paper-input>\n  <span class="help-block" id="deprecatedHelp">List names here in the form <span class="code">"Genus species":"Authority: year","Genus species":"Authority: year",[...]</span>.<br/>There should be no spaces between the quotes and comma or colon. If there are, it may not save correctly.</span>\n'+_asm.dropdownPopulation.major_type.html+"\n"+_asm.dropdownPopulation.major_subtype.html+"\n"+_asm.dropdownPopulation.linnean_order.html+"\n"+_asm.dropdownPopulation.linnean_family.html+"\n"+_asm.dropdownPopulation.simple_linnean_group.html+"\n"+_asm.dropdownPopulation.simple_linnean_subgroup.html+'\n<paper-input label="Genus authority" id="edit-genus-authority" name="edit-genus-authority" class="genus_authority" floatingLabel></paper-input>\n<paper-input label="Genus authority year" id="edit-gauthyear" name="edit-gauthyear" floatingLabel></paper-input>\n<iron-label>\n  Use Parenthesis for Genus Authority\n  <paper-toggle-button id="genus-authority-parens"  checked="false"></paper-toggle-button>\n</iron-label>\n<paper-input label="Species authority" id="edit-species-authority" name="edit-species-authority" class="species_authority" floatingLabel></paper-input>\n<paper-input label="Species authority year" id="edit-sauthyear" name="edit-sauthyear" floatingLabel></paper-input>\n<iron-label>\n  Use Parenthesis for Species Authority\n  <paper-toggle-button id="species-authority-parens" checked="false"></paper-toggle-button>\n</iron-label>\n<br/><br/>\n<paper-input label="ASM ID Number" id="edit-internal-id" name="edit-internal-id" floatingLabel></paper-input>\n<br/>\n<span class="help-block" id="notes-help">You can write your notes and entry in Markdown. (<a href="https://daringfireball.net/projects/markdown/syntax" "onclick=\'window.open(this.href); return false;\' onkeypress=\'window.open(this.href); return false;\'">Official Full Syntax Guide</a>)</span>\n<br/><br/>\n<h3 class=\'text-muted\'>Taxon Notes <small>(optional)</small></h3>\n<iron-autogrow-textarea id="edit-notes" rows="5" aria-describedby="notes-help" placeholder="Notes" class="markdown-region"  data-md-field="notes-markdown-preview">\n  <textarea placeholder="Notes" id="edit-notes-textarea" name="edit-notes-textarea" aria-describedby="notes-help" rows="5"></textarea>\n</iron-autogrow-textarea>\n<marked-element id="notes-markdown-preview" class="markdown-preview">\n  <div class="markdown-html"></div>\n</marked-element>\n<br/><br/>\n<h3 class=\'text-muted\'>Main Taxon Entry</h3>\n<iron-autogrow-textarea id="edit-entry" rows="5" aria-describedby="notes-help" placeholder="Entry" class="markdown-region" data-md-field="entry-markdown-preview">\n  <textarea placeholder="Entry" id="edit-entry-textarea" name="edit-entry-textarea" aria-describedby="entry-help" rows="5"></textarea>\n</iron-autogrow-textarea>\n<marked-element id="entry-markdown-preview" class="markdown-preview">\n  <div class="markdown-html"></div>\n</marked-element>\n<paper-input label="Data Source" id="edit-source" name="edit-source" floatingLabel></paper-input>\n<paper-input label="Data Citation" id="edit-citation" name="edit-source" floatingLabel></paper-input>\n<div id="upload-image"></div>\n<span class="help-block" id="upload-image-help">You can drag and drop an image above, or enter its server path below.</span>\n<paper-input label="Image" id="edit-image" name="edit-image" floatingLabel aria-describedby="imagehelp"></paper-input>\n  <span class="help-block" id="imagehelp">The image path here should be relative to the <span class="code">public_html/</span> directory.</span>\n<paper-input label="Image Caption" id="edit-image-caption" name="edit-image-caption" floatingLabel></paper-input>\n<paper-input label="Image Credit" id="edit-image-credit" name="edit-image-credit" floatingLabel></paper-input>\n<section class="row license-region">\n  <div class="col-xs-9">\n    <paper-input label="Image License" id="edit-image-license" name="edit-image-license" data-license-name="" data-license-url="" floatingLabel readonly></paper-input>\n  </div>\n  <div class="col-xs-3">\n    <paper-icon-button icon="icons:create" id="edit-image-license-dialog" data-license-name="" data-license-url="" data-column="image_license" data-toggle=\'tooltip\' title="Edit License"></paper-icon-button>\n  </div>\n</section>\n<paper-input label="Taxon Credit" id="edit-taxon-credit" name="edit-taxon-credit" floatingLabel aria-describedby="taxon-credit-help" value="'+$.cookie(adminParams.cookieFullName)+'"></paper-input>\n<paper-input label="Taxon Credit Date" id="edit-taxon-credit-date" name="edit-taxon-credit-date" floatingLabel value="'+f+'"></paper-input>\n<span class="help-block" id="taxon-credit-help">This will be displayed as "Entry by <span class=\'taxon-credit-preview\'></span> on <span class=\'taxon-credit-date-preview\'></span>."</span>\n'+a+'\n<input type="hidden" name="edit-taxon-author" id="edit-taxon-author" value="" />',e='<paper-dialog modal id=\'modal-taxon-edit\' entry-animation="scale-up-animation" exit-animation="fade-out-animation">\n  <h2 id="editor-title">Taxon Editor</h2>\n  <paper-dialog-scrollable id=\'modal-taxon-editor\'>\n    '+d+"\n  </paper-dialog-scrollable>\n  <div class=\"buttons\">\n    <paper-button id='close-editor' dialog-dismiss>Cancel</paper-button>\n    <paper-button id='duplicate-taxon'>Duplicate</paper-button>\n    <paper-button id='save-editor'>"+b+"</paper-button>\n  </div>\n</paper-dialog>",$("#modal-taxon-edit").exists()&&$("#modal-taxon-edit").remove(),$("#search-results").after(e);try{newColumnHelper()}catch(a){c=a,console.warn("Couldn't bind columns: "+c.message),console.warn(c.stack)}try{licenseHelper()}catch(a){c=a,console.warn("Couldn't set license helper: "+c.message),console.warn(c.stack)}return handleDragDropImage(),$("#modal-taxon-edit").unbind(),d$("#save-editor").unbind(),d$("#duplicate-taxon").unbind().click(function(){return createDuplicateTaxon()})},handleDeprecatedInput=function(){return!1},renderDeprecatedFromDatabase=function(){return!1},fillEmptyCommonName=function(){return!1},createNewTaxon=function(){var a,b;return animateLoad(),loadModalTaxonEditor("","Create"),d$("#editor-title").text("Create New Taxon"),b=.5*$(window).height(),d$("#modal-taxon-editor").css("min-height",b+"px"),d$("#modal-taxon-editor div.scrollable").css("max-height",""),d$("#modal-taxon-edit").addClass("create-new-taxon"),d$("#duplicate-taxon").remove(),a=isNull($.cookie(uri.domain+"_fullname"))?$.cookie(uri.domain+"_user"):$.cookie(uri.domain+"_fullname"),d$("#edit-taxon-author").attr("value",a),d$("#save-editor").click(function(){return saveEditorEntry("new")}),$("#modal-taxon-edit").get(0).open(),stopLoad()},createDuplicateTaxon=function(){var a,b;animateLoad();try{d$("#taxon-id").remove(),d$("#last-edited-by").remove(),d$("#duplicate-taxon").remove(),d$("#editor-title").text("Create Duplicate Taxon"),b='<paper-button id="save-editor">Create</paper-button>',d$("#save-editor").replaceWith(b),d$("#save-editor").click(function(){return saveEditorEntry("new")}),delay(250,function(){return stopLoad()})}catch(b){a=b,stopLoadError("Unable to duplicate taxon"),console.error("Couldn't duplicate taxon! "+a.message),d$("#modal-taxon-edit").get(0).close()}return!0},lookupEditorSpecies=function(a){var b,c,d,e,f,g,h,i,j,k,l;if(null==a&&(a=void 0),null==a)return!1;if(animateLoad(),f="<p id=\"last-edited-by\">\n  Last edited by <span id=\"taxon-author-last\" class=\"capitalize\"></span>\n</p>\n<input type='hidden' name='taxon-id' id='taxon-id'/>",loadModalTaxonEditor(f),d$("#save-editor").click(function(){return saveEditorEntry()}),c=d$("#last-edited-by").exists(),c||d$("#taxon-credit-help").after(f),h=void 0,g=void 0,b="q="+a,-1!==a.search(/\(/)){for(g={genus:"",species:"",subspecies:""},h={genus:"",species:"",subspecies:""},k=a.split("+"),e=0;e<k.length;){switch(l=k[e],console.log("Checking '"+l+"'"),toInt(e)){case 0:d=l.split("("),console.log("Looking at genus array",d),g.genus=d[0].trim(),h.genus=null!=d[1]?d[1].trim().slice(0,-1):d[0];break;case 1:i=l.split("("),console.log("Looking at species array",i),g.species=i[0].trim(),h.species=null!=i[1]?i[1].trim().slice(0,-1):i[0];break;case 2:j=l.split("("),console.log("Looking at ssp array",j),g.subspecies=j[0].trim(),h.subspecies=null!=j[1]?j[1].trim().slice(0,-1):j[0];break;default:console.error("K value of '"+e+"' didn't match 0,1,2!")}k[e]=l.trim(),e++}a=g.genus+"+"+g.species,isNull(g.subspecies)||(a+=g.subspecies),b="q="+a+"&loose=true",console.warn("Bad name! Calculated out:"),console.warn("Should be currently",h),console.warn("Was previously",g),console.warn("Pinging with",""+uri.urlString+searchParams.targetApi+"?q="+a)}return $.get(searchParams.targetApi,b,"json").done(function(b){var c,d,e,f,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B;try{if(console.debug("Admin lookup rending editor UI for",b),null==(k=b.result[0]))return stopLoadError("Sorry, there was a problem parsing the information for this taxon. If it persists, you may have to fix it manually."),console.error("No data returned for",searchParams.targetApi+"?q="+a),!1;try{k.deprecated_scientific=JSON.parse(k.deprecated_scientific)}catch(a){m=a}null!=g&&(toastStatusMessage("Bad information found. Please review and resave."),k.genus=h.genus,k.species=h.species,k.subspecies=h.subspecies,"object"!=typeof k.deprecated_scientific&&(k.deprecated_scientific={}),t=g.species,isNull(g.subspecies)||(t+=" "+g.subspecies),k.deprecated_scientific[g.genus.toTitleCase()+" "+t]="AUTHORITY: YEAR"),y=["parens_auth_genus","parens_auth_species"];for(e in k){j=k[e];try{"string"==typeof j&&(j=j.trim())}catch(a){}"id"===e&&$("#taxon-id").attr("value",j),f=!1;try{l="#edit-"+e.replace(/\_/g,"-"),"paper-dropdown-menu"===$(l).get(0).tagName.toLowerCase()&&(f=!0)}catch(a){}if(console.debug("Col editor exists for '"+l+"'?",f),f&&(console.debug("Trying to polymer-select",j),$(l).polymerSelected(j,!0)),"species_authority"!==e&&"genus_authority"!==e||isNull(j.match(/\(? *([\w\. \[\]]+), *([0-9]{4}) *\)?/g))||(o=j.search(/\(/)>=0&&j.search(/\)/)>=0,c=j.replace(/[\(\)]/g,"").split(","),j=c[0].trim(),B=toInt(c[1]),"genus_authority"===e&&$("#edit-gauthyear").attr("value",B),"species_authority"===e&&$("#edit-sauthyear").attr("value",B),o&&(p$("#"+e.replace(/\_/g,"-")+"-parens").checked=!0)),"authority_year"===e)"object"==typeof(B=parseTaxonYear(j))&&($("#edit-gauthyear").attr("value",B.genus),$("#edit-sauthyear").attr("value",B.species));else if(indexOf.call(y,e)>=0)i=e.split("_"),"parens"===i[0]?(d=e.split("_").pop(),u="#"+d+"-authority-parens"):u="#"+e.replace(/_/g,"-"),d$(u).polymerChecked(toInt(j).toBool());else if("taxon_author"===e)"null"===j||isNull(j)?($("#last-edited-by").remove(),console.warn("Removed #last-edited-by! Didn't have an author provided for column '"+e+"', giving '"+j+"'. It's probably the first edit to this taxon.")):d$("#taxon-author-last").text(j),z=isNull($.cookie(uri.domain+"_fullname"))?$.cookie(uri.domain+"_user"):$.cookie(uri.domain+"_fullname"),d$("#edit-taxon-author").attr("value",z);else if("taxon_credit"===e)n="#edit-"+e.replace(/_/g,"-"),p$(n).value=$.cookie(adminParams.cookieFullName);else if("image_license"===e){q=j.unescape();try{p=JSON.parse(q);for(r in p){s=p[r],$("#edit-image-license-dialog").attr("data-license-name",r).attr("data-license-url",s),$("#edit-image-license").attr("data-license-name",r).attr("data-license-url",s),j=r+" @ "+s;break}}catch(a){j=q}p$("#edit-image-license").value=j}else"taxon_credit_date"===e?isNull(j)&&(x=new Date,j=x.toISOString().split("T")[0],n="#edit-"+e.replace(/_/g,"-"),p$(n).value=j):(n="#edit-"+e.replace(/_/g,"-"),"deprecated_scientific"===e&&(j=JSON.stringify(j).trim().replace(/\\/g,""),j=j.replace(/{/,""),'""'===(j=j.replace(/}/,""))&&(j="")),v=["notes","entry"],indexOf.call(v,e)<0?d$(n).attr("value",j):(A=.9*$("#modal-taxon-edit").width(),d$(n).css("width",A+"px"),w=p$(n).textarea,$(w).text(j.unescape())))}return p$("#modal-taxon-edit"),$("#modal-taxon-edit").on("iron-overlay-opened",function(){var a,b,c,d,e,f,g,h,i,j;p$("#modal-taxon-edit").refit(),g=p$("#edit-common-name").value,$("#edit-common-name").keyup(function(){var a,b;return console.debug("Common name field edited!"),p$(this).value!==g?(a=$.cookie(adminParams.cookieFullName),b="user:"+a):b="iucn",p$("#edit-common-name-source").value=b,!1}),_asm.updateImageField=function(a){var b,c;return b=p$(a).value,console.log("Should render preview image of ",b),$("#preview-main-image").exists()&&$("#preview-main-image").remove(),c='<img id="preview-main-image" class=\'preview-image\' src="'+b+'" />',$("#imagehelp").after(c),!1},$("#edit-image").on("focus",function(){var a;return a=this,_asm.updateImageField.debounce(null,null,null,a),!1}).on("blur",function(){var a;return a=this,_asm.updateImageField.debounce(null,null,null,a),!1}).on("keyup",function(){var a;return a=this,_asm.updateImageField.debounce(null,null,null,a),!1});try{_asm.updateImageField(p$("#edit-image"))}catch(a){}for(e=function(a){var b;return b=p$(a).value,$("#taxon-credit-help .taxon-credit-preview").text(b),b},a=function(a){var b,c,d;return b=p$(a).value,c=new Date(b),d=c.getUTCDate()+" "+dateMonthToString(c.getUTCMonth())+" "+c.getUTCFullYear(),$("#taxon-credit-help .taxon-credit-date-preview").text(d),d},$("#edit-taxon-credit").keyup(function(){return e(this),!1}),$("#edit-taxon-credit-date").keyup(function(){return a(this),!1}),e(p$("#edit-taxon-credit")),a(p$("#edit-taxon-credit-date")),b=$(p$("#edit-entry").textarea).val(),f=$(p$("#edit-notes").textarea).val(),p$("#entry-markdown-preview").markdown=b,p$("#notes-markdown-preview").markdown=f,h=$(".markdown-region"),j=[],d=0,c=h.length;d<c;d++)i=h[d],j.push($(p$(i).textarea).keyup(function(){var a,b;a=$(this).val(),b=$(this).parents("iron-autogrow-textarea").attr("data-md-field");try{return p$("#"+b).markdown=a,console.debug("Wrote markdown to target '#"+b+"'")}catch(c){return m=c,console.warn("Can't update preview for target '#"+b+"'",$(this).get(0),a)}}));return j}),safariDialogHelper("#modal-taxon-edit"),stopLoad()}catch(a){return m=a,stopLoadError("Unable to populate the editor for this taxon - "+m.message),console.error("Error populating the taxon popup -- "+m.message),console.warn(m.stack)}}).fail(function(a,b){return stopLoadError("There was a server error populating this taxon. Please try again.")}),!1},saveEditorEntry=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X;null==a&&(a="save"),t=["genus","species","subspecies","common-name","major-type","major-subtype","linnean-order","linnean-family","simple-linnean-group","simple-linnean-subgroup","genus-authority","species-authority","notes","entry","image","image-credit","image-license","taxon-author","taxon-credit","taxon-credit-date","internal-id","source","citation"],L={},s=!1,d$("paper-input").removeAttr("invalid");try{R=function(a,b){var c,d,e,f,g,h,i,j,k;if(null==b&&(b=!1),j=b?a:d$(a).val(),f=void 0,g=1707,e=new Date,h=e.getUTCFullYear()+1,d=/^[1-2][07-9]\d{2}$|^[1-2][07-9]\d{2} (\"|')[1-2][07-9]\d{2}\1$/,isNumber(j)&&g<j&&j<h||(d.test(j)?-1===j.search(" ")?f="This must be a valid year between "+g+" and "+h:(k=j.split(" "),g<(i=k[0])&&i<h||(f="The first year must be a valid year between "+g+" and "+h),c=k[1].replace(/(\"|')/g,""),g<c&&c<h||(f="The second year must be a valid year between "+g+" and "+h),j=j.replace(/'/g,'"')):f=-1===j.search(" ")?"This must be a valid year between "+g+" and "+h:"Nonstandard years must be of the form: YYYY 'YYYY', eg, 1801 '1802'"),null!=f){if(s=!0,console.warn(a+" failed its validity checks for `"+j+"`!"),b)throw Error(f);d$(""+a).attr("error-message",f).attr("invalid","invalid")}return j};try{u=R("#edit-gauthyear"),K=R("#edit-sauthyear"),console.log("Escape Completion State:",s)}catch(a){p=a,console.error("Unable to parse authority year! "+p.message),d=""}c={},c[u]=K,d=JSON.stringify(c)}catch(a){p=a,console.error("Failed to JSON parse the authority year - "+p.message),d=""}L.authority_year=d;try{if(k={},m=d$("#edit-deprecated-scientific").val(),isNull(m))n="";else{for(l=m.split('","'),F=0,B=l.length;F<B;F++)z=l[F],y=z.split('":"'),k[y[0].replace(/"/g,"")]=y[1].replace(/"/g,"");console.log("Validating",k);for(Q in k){if(e=k[Q],f=e.split(":"),console.log("Testing "+e,f),2!==f.length)throw Error("Authority string should have an authority and year seperated by a colon.");if(c=f[0].trim(),T=f[1].trim(),-1!==T.search(","))throw Error("Looks like there may be an extra space, or forgotten \", near '"+T+"' ");X=R(T,!0),console.log("Validated",c,X)}if(n=JSON.stringify(k),n.replace(/[{}]/g,"")!==m)throw Error("Badly formatted entry - generated doesn't match read")}}catch(a){p=a,console.error("Failed to parse the deprecated scientifics - "+p.message+". They may be empty."),n="",r=p.message+". Check your formatting!",d$("#edit-deprecated-scientific").attr("error-message",r).attr("invalid",!0),s=!0,
i="There was a problem with your formatting for the deprecated scientifics. Please check it and try again."}L.deprecated_scientific=n,A=["notes","taxon_credit","image","image_credit","image_license"],I=["common-name","major-type","linnean-order","genus-authority","species-authority"],isNull(d$("#edit-image").val())||(I.push("image-credit"),I.push("image-license")),isNull(d$("#edit-taxon-credit").val())||I.push("taxon-credit-date");for(z in t){w=t[z];try{g=w.replace(/-/g,"_")}catch(a){console.warn("Unable to test against id '"+w+"'");continue}S="#edit-"+g.replace(/\_/gim,"-"),h=!1;try{o=S,"paper-dropdown-menu"===$(o).get(0).tagName.toLowerCase()&&(h=!0)}catch(a){}if(console.debug("Col editor exists for '"+o+"'?",h),h)V=$(o).polymerSelected();else if("image_license"===g)W={},C=$("#edit-image-license").attr("data-license-name"),D=$("#edit-image-license").attr("data-license-url"),W[C]=D,V=JSON.stringify(W);else{x=!1;try{"iron-autogrow-textarea"===$("#edit-"+w).get(0).tagName.toLowerCase()&&(x=!0)}catch(a){}if(x){V=p$("#edit-"+w).value,isNull(V)&&(V=$(p$("#edit-"+w).textarea).val());try{V=V.trim()}catch(a){}}else try{V=d$("#edit-"+w).val().trim()}catch(a){p=a,V="",q="Unable to get value for "+w,console.warn(q+": "+p.message),toastStatusMessage(q)}}if(indexOf.call(A,g)<0)try{isNumber(V)&&(V===""+toInt(V)?V=toInt(V):vale===""+toFloat(V)&&(V=toFloat(V))),V=V.toLowerCase()}catch(a){p=a,console.warn("Column '"+g+"' threw error for value '"+V+"': "+p.message),isNull(V)&&(V="")}switch(w){case"genus":case"species":case"subspecies":r="This required field must have only letters",G=("genus"===w||"species"===w)&&isNull(V),(/[^A-Za-z]/m.test(V)||G)&&(d$("#edit-"+w).attr("error-message",r).attr("invalid","invalid"),s=!0);break;case"common-name":case"major-type":case"linnean-order":case"genus-authority":case"species-authority":r="This cannot be empty",isNull(V)&&($("#edit-"+w).attr("error-message",r).attr("invalid","invalid"),s=!0);break;default:indexOf.call(I,w)>=0&&(O="#edit-"+w,P="This must not be empty","#edit-image-credit"!==O&&"#edit-image-license"!==O||(P="This cannot be empty if an image is provided"),"#edit-taxon-credit-date"===O&&(H=new Date(V),"Invalid Date"===H?(P="We couldn't understand your date format. Please try again.",V=null):(V=H.toISOString().split("T")[0],$(O).attr("value",V),P="If you have a taxon credit, it also needs a date")),isNull(V)&&(d$("#edit-"+w).attr("error-message",P).attr("invalid","invalid"),s=!0))}L[g]=V}return L.id=toInt(d$("#taxon-id").val()),L.parens_auth_genus=d$("#genus-authority-parens").polymerChecked(),L.parens_auth_species=d$("#species-authority-parens").polymerChecked(),L.canonical_sciname=isNull(L.subspecies)?L.genus.toTitleCase()+" "+L.species:L.genus.toTitleCase()+" "+L.species+" "+L.subspecies,s?(animateLoad(),j=null!=i?i:"Bad characters in entry. Stopping ...",null==i&&(i="There was a problem with your entry. Please correct your entry and try again."),stopLoadError(i),console.error(j),console.warn("Save object so far:",L),!0):"save"!==a||isNumber(L.id)?(M=JSON.stringify(L),J=Base64.encodeURI(M),isNull(M)||isNull(J)?(animateLoad(),stopLoadError("The system was unable to parse this entry for the server. Please see the console for more details."),console.error("Unable to stringify the JSON!."),console.warn("The total save object so far is:",L),console.warn("Got the output string",saveSring),console.warn("Sending b64 string",J),!0):(v=$.cookie(uri.domain+"_auth"),N=$.cookie(uri.domain+"_secret"),E=$.cookie(uri.domain+"_link"),U="hash="+v+"&secret="+N+"&dblink="+E,b="perform="+a+"&"+U+"&data="+J,console.log("Going to save",L),console.log("Using mode '"+a+"'"),animateLoad(),$.post(adminParams.apiTarget,b,"json").done(function(a){return!0===a.status?(console.log("Server returned",a),s?(stopLoadError("Warning! The item saved, even though it wasn't supposed to."),!1):(d$("#modal-taxon-edit").get(0).close(),isNull($("#admin-search").val())||renderAdminSearchResults(),stopLoad(),delay(250,function(){return stopLoad()}),console.log("Save complete"),!1)):(stopLoadError(a.human_error),console.error(a.error),console.warn("Server returned",a),console.warn("We sent",""+uri.urlString+adminParams.apiTarget+"?"+b),!1)}).fail(function(a,c){return stopLoadError("Failed to send the data to the server."),console.error("Server error! We sent",""+uri.urlString+adminParams.apiTarget+"?"+b),!1}))):(animateLoad(),stopLoadError("The system was unable to generate a valid taxon ID for this entry. Please see the console for more details."),console.error("Unable to get a valid, numeric taxon id! We got '"+L.id+"'."),console.warn("The total save object so far is:",L),!1)},deleteTaxon=function(a){var b,c,d,e,f;return c=$(".delete-taxon .delete-taxon-button[data-database-id='"+a+"']"),f=c.attr("data-taxon").replace(/\+/g," "),e=f.substr(0,1).toUpperCase()+f.substr(1),c.hasClass("extreme-danger")?null!=window.deleteWatchTimer?(d=Date.now()-window.deleteWatchTimer,console.warn("The taxon was asked to be deleted "+d+"ms after the confirmation was prompted. Rejecting ..."),!1):(animateLoad(),b="perform=delete&id="+a,$.post(adminParams.apiTarget,b,"json").done(function(b){return!0===b.status?(c.parents("tr").remove(),toastStatusMessage(e+" with ID "+a+" has been removed from the database."),stopLoad()):(stopLoadError(b.human_error),console.error(b.error),console.warn(b)),!1}).fail(function(a,b){return stopLoadError("Failed to communicate with the server."),!1})):(window.deleteWatchTimer=Date.now(),delay(300,function(){return delete window.deleteWatchTimer}),c.addClass("extreme-danger"),delay(7500,function(){return c.removeClass("extreme-danger")}),toastStatusMessage("Click again to confirm deletion of "+e),!1)},handleDragDropImage=function(a,b){return null==a&&(a="#upload-image"),"function"!=typeof b&&(b=function(a,b){var c,d,e,f,g;if(!0!==b.status)return null==b.human_error&&(b.human_error="There was a problem uploading your image."),toastStatusMessage(b.human_error),console.error("Error uploading!",b),!1;try{e=a.name,_asm.dropzone.disable(),d=e.split(".").pop(),f=md5(e)+"."+d,g="species_photos/"+f,d$("#edit-image").attr("disabled","disabled").attr("value",g),toastStatusMessage("Upload complete")}catch(a){c=a,console.error("There was a problem with upload post-processing - "+c.message),console.warn("Using",e,b),toastStatusMessage("Your upload completed, but we couldn't post-process it.")}return!1}),loadJS("bower_components/JavaScript-MD5/js/md5.min.js"),loadJS("bower_components/dropzone/dist/min/dropzone.min.js",function(){var c,d,e,f,g;return c=document.createElement("link"),c.setAttribute("rel","stylesheet"),c.setAttribute("type","text/css"),c.setAttribute("href","css/dropzone.min.css"),document.getElementsByTagName("head")[0].appendChild(c),Dropzone.autoDiscover=!1,d="Drop a high-resolution image for the taxon here.",e=function(){return d$(a).css("box-shadow","").css("border",""),d$(a+" .dz-message span").text(d)},f={url:uri.urlString+"meta.php?do=upload_image",acceptedFiles:"image/*",autoProcessQueue:!0,maxFiles:1,dictDefaultMessage:d,init:function(){return this.on("error",function(){return toastStatusMessage("An error occured sending your image to the server.")}),this.on("canceled",function(){return toastStatusMessage("Upload canceled.")}),this.on("dragover",function(){return d$(a+" .dz-message span").text("Drop here to upload the image"),d$(a).css("box-shadow","0px 0px 15px rgba(15,157,88,.8)").css("border","1px solid #0F9D58")}),this.on("dragleave",function(){return e()}),this.on("dragend",function(){return e()}),this.on("drop",function(){return e()}),this.on("success",function(a,c){return b(a,c)})}},d$(a).hasClass("dropzone")||d$(a).addClass("dropzone"),g=new Dropzone(d$(a).get(0),f),_asm.dropzone=g}),!1},adminPreloadSearch=function(){var a,b;try{uri.query=$.url().attr("fragment")}catch(a){}if("#"===uri.query||isNull(uri.query))return!1;try{b=Base64.decode(uri.query),b=JSON.parse(b)}catch(a){}return"object"==typeof b?isNull(b.genus)||isNull(b.species)?(console.error("Bad taxon format"),!1):(a=b.genus+" "+b.species,isNull(b.subspecies)||(a+=" "+b.subspecies),$("#admin-search").val(a),renderAdminSearchResults(),b):(console.error("Bad fragment: unable to read JSON",b),!1)},$(function(){$("#next").exists()&&$("#next").unbind().click(function(){return openTab(adminParams.adminPageUrl)}),loadJS("bower_components/bootstrap/dist/js/bootstrap.min.js",function(){return $("[data-toggle='tooltip']").tooltip()});try{prefetchEditorDropdowns()}catch(a){}try{return adminPreloadSearch()}catch(a){}});
//# sourceMappingURL=admin.min.js.map