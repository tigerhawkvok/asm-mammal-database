var downloadCSVList,downloadHTMLList,showDownloadChooser;downloadCSVList=function(a){var b,c,d,e,f,g,h,i,j,k,l,m;null==a&&(a=!1),animateLoad(),m=Date.now(),_asm.progressTracking={estimate:[]};try{l=a?searchParams.lastSearch:"*",isNull(l)&&(l="*")}catch(a){l="*"}try{for(k=$("#download-chooser .buttons paper-button"),h=0,i=k.length;h<i;h++)d=k[h],p$(d).disabled=!0}catch(a){}return c="q="+l,e=new Date,b=e.getMonth()+1,j=1===(""+b).length?"0"+b:b,g=1===(""+e.getDate()).length?"0"+e.getDate():e.getDate(),f=e.getUTCFullYear()+"-"+j+"-"+g,$.get(""+searchParams.apiPath,c,"json").done(function(a){var b,d,e;try{if(!0!==a.status)throw Error("Invalid Result");return startLoad(),toastStatusMessage("Please be patient while we create the file for you"),d={action:"render-csv",data:a},e=new Worker("js/serviceWorker.min.js"),console.info("Rendering list off-thread"),e.addEventListener("message",function(a){var b,c,d,e,g,h,i,j,k,l,n,o;if(!0!==a.data.status)return console.warn("Got an error!"),k=isNull(a.data.updateUser)?"Failed to create file":a.data.updateUser,stopLoadError(k,void 0,1e4),!1;if(!0!==a.data.done)return isNull(a.data.updateUser)?isNumber(a.data.progress)?($("#download-progress-indicator").exists()||(j='<paper-progress\n  class="transiting"\n  id="download-progress-indicator"\n  value="0"\n  max="1000">\n</paper-progress>\n<p>\n  <span class="bold">Estimated Time Remaining:</span> <span id="estimated-remaining-time">&#8734;</span>s\n</p>',$("#download-chooser .dialog-content .scrollable").append(j)),p$("#download-progress-indicator").value=a.data.progress,n=Date.now()-m,i=toFloat(a.data.progress)/1e3,o=n/i,_asm.progressTracking.estimate.push(o),b=_asm.progressTracking.estimate.mean(),g=b-n,$("#estimated-remaining-time").text(toInt(g/1e3))):console.log("Just an update",a.data):(console.log("Toasting: "+a.data.updateUser),toastStatusMessage(a.data.updateUser,1e3)),!1;d=a.data.csv;try{h=d.length/1024/1024}catch(a){h=0}return console.log("Downloadable size: "+h+" MiB"),null===_asm.sqlDumpLocation?(l='<div id="download-sql-summary" class="data-download-button">\n  <paper-spinner active></paper-spinner> Please wait while your SQL creation finishes ...\n</div>',(c=function(){return null===_asm.sqlDumpLocation?delay(250,function(){return c()}):(l=!1===_asm.sqlDumpLocation?'<a href="#" class="btn btn-danger data-download-button" id="download-sql-summary" disabled><iron-icon icon="icons:error"></iron-icon> SQL Creation Failed</a>':'<a href="'+_asm.sqlDumpLocation+'" download="asm-species-'+f+'.sql" class="btn btn-default data-download-button" id="download-sql-summary"><iron-icon icon="icons:file-download"></iron-icon> Download SQL</a>',$("#download-sql-summary").replaceWith(l)),!1})()):l=!1===_asm.sqlDumpLocation?'<a href="#" class="btn btn-danger data-download-button" id="download-sql-summary" disabled><iron-icon icon="icons:error"></iron-icon> SQL Creation Failed</a>':'<a href="'+_asm.sqlDumpLocation+'" download="asm-species-'+f+'.sql" class="btn btn-default data-download-button" id="download-sql-summary"><iron-icon icon="icons:file-download"></iron-icon> Download SQL</a>',j='<paper-dialog class="download-file" id="download-csv-file" modal>\n  <h2>Your files are ready</h2>\n  <paper-dialog-scrollable class="dialog-content">\n    <h3>Want to do data analysis?</h3>\n    <p>\n      We have an open API! Read all of our parameters here:\n      <a href="https://github.com/tigerhawkvok/asm-mammal-database/blob/master/README.md#api"  onclick=\'window.open(this.href); return false;\' onkeypress=\'window.open(this.href); return false;\'>README API Documentation <iron-icon icon="launch"></iron-icon></a>\n      <br/><br/>\n      We also have a UI to perform permission-restricted SQL queries on the database TODO\n    </p>\n    <h3>Which file type do I want?</h3>\n    <p>\n      A CSV file is readily opened by consumer-grade programs, such as Microsoft Excel or Google Spreadsheets.\n      It has some transformations done to the raw data to make it more readable.\n      <br/><br/>\n      However, if you wish to replicate the whole database and perform queries, the SQL file is machine-readable,\n      ready for import into a MySQL or MariaDB database by running the <code>source asm-species-'+f+'.sql;</code> in their\n      interactive shell prompts when run from your download directory. This file has not been transformed in any way.\n    </p>\n    <h3>Excel Important Note</h3>\n    <p>\n      Please note that some special characters in names may be decoded incorrectly by Microsoft Excel. If this is a problem, following the steps in <a href="https://github.com/tigerhawkvok/asm-mammal-database/blob/master/meta/excel_unicode_readme.md"  onclick=\'window.open(this.href); return false;\' onkeypress=\'window.open(this.href); return false;\'>this README <iron-icon icon="icons:launch"></iron-icon></a> to force Excel to format it correctly.\n    </p>\n    <p class="text-center">\n      <a href="'+d+'" download="asm-species-'+f+'.csv" class="btn btn-default data-download-button" id="download-csv-summary"><iron-icon icon="icons:file-download"></iron-icon> Download CSV</a>\n      '+l+'\n    </p>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',$("#download-csv-file").exists()?$("#download-csv-file").replaceWith(j):$("body").append(j),p$("#download-chooser").close(),h>=2?(console.debug("Large file size triggering blob creation"),downloadDataUriAsBlob("#download-csv-summary")):console.debug("File size is small enough to use a data-uri"),delay(250,function(){return safariDialogHelper("#download-csv-file")}),stopLoad(),e=Date.now()-m,console.debug("CSV time elapsed: "+e+"ms"),!1}),e.postMessage(d),!1}catch(d){return b=d,stopLoadError("There was a problem creating the CSV file. Please try again later."),console.error("Exception in downloadCSVList ) - "+b.message),console.warn(b.stack),console.warn("Got",a,"from",searchParams.apiPath+"?"+c,a.status)}}).fail(function(){return stopLoadError("There was a problem communicating with the server. Please try again later.")}),_asm.sqlDumpLocation=null,$.get(uri.urlString+"meta.php","action=get_db_dump","json").done(function(a){return!0===a.status?_asm.sqlDumpLocation=a.download_path:_asm.sqlDumpLocation=!1,!1}).fail(function(a,b){return!1}),!1},downloadHTMLList=function(a){var b,c,d,e,f,g;null==a&&(a=!1),startLoad(),g=Date.now(),_asm.progressTracking={estimate:[]};try{f=a?searchParams.lastSearch:"*",isNull(f)&&(f="*")}catch(a){f="*"}try{for(e=$("#download-chooser .buttons paper-button"),c=0,d=e.length;c<d;c++)b=e[c],p$(b).disabled=!0}catch(a){}return $.get(uri.urlString+"css/download-inline-bootstrap.css").done(function(a){var b,c,d,e,h,i,j;return d=new Date,b=d.getMonth()+1,j=1===(""+b).length?"0"+b:b,h=1===(""+d.getDate()).length?"0"+d.getDate():d.getDate(),e=d.getUTCFullYear()+"-"+j+"-"+h,i='<!doctype html>\n<html lang="en">\n  <head>\n    <title>ASM Species Checklist ver. '+e+'</title>\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta charset="UTF-8"/>\n    <meta name="theme-color" content="#445e14"/>\n    <meta name="viewport" content="width=device-width, initial-scale=1" />\n    <link href=\'http://fonts.googleapis.com/css?family=Droid+Serif:400,700,700italic,400italic|Roboto+Slab:400,700\' rel=\'stylesheet\' type=\'text/css\' />\n    <style type="text/css" id="asm-checklist-inline-stylesheet">\n      '+a+'\n    </style>\n  </head>\n  <body>\n    <div class="container-fluid">\n      <article>\n        <h1 class="text-center">ASM Species Checklist ver. '+e+"</h1>",c="q="+f+"&order=linnean_order,linnean_family,genus,species,subspecies",$.get(""+searchParams.apiPath,c,"json").done(function(a){var b,c;return startLoad(),toastStatusMessage("Please be patient while we create the file for you"),b={action:"render-html",data:a,htmlHeader:i},c=new Worker("js/serviceWorker.min.js"),console.info("Rendering list off-thread"),c.addEventListener("message",function(a){var b,c,d,f,h,j,k,l,m,n,o;if(!0!==a.data.status)return console.warn("Got an error!"),l=isNull(a.data.updateUser)?"Failed to create file":a.data.updateUser,stopLoadError(l,void 0,1e4),!1;if(!0!==a.data.done){if(isNull(a.data.updateUser))if(isNumber(a.data.progress)){$("#download-progress-indicator").exists()||(k='<paper-progress\n  class="transiting"\n  id="download-progress-indicator"\n  value="0"\n  max="1000">\n</paper-progress>\n<p>\n  <span class="bold">Estimated Time Remaining:</span> <span id="estimated-remaining-time">&#8734;</span>s\n</p>',$("#download-chooser .dialog-content .scrollable").append(k));try{p$("#download-progress-indicator").value=a.data.progress}catch(a){}n=Date.now()-g,j=toFloat(a.data.progress)/1e3,o=n/j,_asm.progressTracking.estimate.push(o),b=_asm.progressTracking.estimate.mean(),f=b-n,$("#estimated-remaining-time").text(toInt(f/1e3))}else console.log("Just an update",a.data);else console.log("Toasting: "+a.data.updateUser),toastStatusMessage(a.data.updateUser,1e3);return!1}i=a.data.html,d="data:text/html;charset=utf-8,"+encodeURIComponent(i);try{h=d.length/1024/1024}catch(a){h=0}console.log("Downloadable size: "+h+" MiB"),c='<paper-dialog  modal class="download-file" id="download-html-file">\n  <h2>Your file is ready</h2>\n  <paper-dialog-scrollable class="dialog-content">\n    <p>\n      Please note that some taxa may have had incomplete data. Please download a CSV or SQL file for the uncombined taxon data.\n    </p>\n    <p class="text-center">\n      <a href="'+d+'" download="asm-species-'+e+'.html" class="btn btn-default data-download-button" id="download-html-summary"><iron-icon icon="icons:file-download"></iron-icon> Download HTML</a>\n      <div id="pdf-download-placeholder" class="data-download-button">\n        <paper-spinner active></paper-spinner> Please wait while your PDF creation finishes ...\n      </div>\n    </p>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',$("#download-html-file").exists()?$("#download-html-file").replaceWith(c):$("body").append(c),$("#download-chooser").on("iron-overlay-closed",function(){return delay(100,function(){return $(this).remove()})});try{p$("#download-chooser").close()}catch(a){}return h>=2?(console.debug("Large file size triggering blob creation"),downloadDataUriAsBlob("#download-html-summary")):console.debug("File size is small enough to use a data-uri"),safariDialogHelper("#download-html-file"),stopLoad(),toastStatusMessage("Please wait while we prepare your PDF file...","",7e3),m='<a href="#" disabled class="btn btn-danger" id="download-pdf-summary"><iron-icon icon="icons:error"></iron-icon> PDF Creation Failed</a>',console.debug("Posting for PDF"),$.post(uri.urlString+"pdf/pdfwrapper.php","html="+encodeURIComponent(i),"json").done(function(a){var b,c;return console.debug("PDF result",a),a.status?(c=""+uri.urlString+a.file,console.debug(c),b='<a href="'+c+'" download="asm-species-'+e+'.pdf" class="btn btn-default data-download-button" id="download-pdf-summary"><iron-icon icon="file-download"></iron-icon> Download PDF</a>',$("#download-html-file #download-html-summary").after(b)):(console.error("Couldn't make PDF file"),$("#download-html-file #download-html-summary").after(m))}).error(function(a,b){return console.error("Wasn't able to fetch PDF"),$("#download-html-file #download-html-summary").after(m)}).always(function(){var a;try{$("#download-html-file #pdf-download-placeholder").remove()}catch(a){}return a=Date.now()-g,console.debug("HTML+PDF time elapsed: "+a+"ms")}),!1}),c.postMessage(b),!1}).fail(function(){return stopLoadError("There was a problem communicating with the server. Please try again later.")})}).fail(function(){return stopLoadError("Unable to fetch styles for printout"),!1}),!1},showDownloadChooser=function(){var a;return a='<paper-dialog id="download-chooser" modal>\n  <h2>Select Download Type</h2>\n  <paper-dialog-scrollable class="dialog-content">\n    <p>\n      Once you select a file type, it will take a moment to prepare your download. Please be patient.\n    </p>\n    <div>\n      <paper-toggle-button id="use-search">Use current search results</paper-toggle-button>\n    </div>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Cancel</paper-button>\n    <paper-button id="initiate-csv-download">CSV/SQL</paper-button>\n    <paper-button id="initiate-html-download">HTML/PDF</paper-button>\n  </div>\n</paper-dialog>',$("#download-chooser").exists()||$("body").append(a),$("#initiate-csv-download").click(function(){var a;try{a=p$("#use-search").checked}catch(b){a=!1}try{p$("#use-search").disabled=!0}catch(a){}return downloadCSVList(a)}),$("#initiate-html-download").click(function(){var a;try{a=p$("#use-search").checked}catch(b){a=!1}try{p$("#use-search").disabled=!0}catch(a){}return downloadHTMLList(a)}),$("#download-chooser").on("iron-overlay-closed",function(){return delay(100,function(a){return function(){return $(a).remove()}}(this))}),safariDialogHelper("#download-chooser"),!1};
//# sourceMappingURL=download.min.js.map