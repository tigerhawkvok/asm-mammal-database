var downloadCSVList,downloadHTMLList,showDownloadChooser;downloadCSVList=function(){var a,b,c,d,e,f,g,h,i,j,k;animateLoad(),k=Date.now(),_asm.progressTracking={estimate:[]};try{for(j=$("#download-chooser .buttons paper-button"),g=0,h=j.length;g<h;g++)c=j[g],p$(c).disabled=!0}catch(a){}return b="q=*",d=new Date,a=d.getMonth()+1,i=1===(""+a).length?"0"+a:a,f=1===(""+d.getDate()).length?"0"+d.getDate():d.getDate(),e=d.getUTCFullYear()+"-"+i+"-"+f,$.get(""+searchParams.apiPath,b,"json").done(function(a){var c,d,f;try{if(!0!==a.status)throw Error("Invalid Result");return startLoad(),toastStatusMessage("Please be patient while we create the file for you"),d={action:"render-csv",data:a},f=new Worker("js/serviceWorker.min.js"),console.info("Rendering list off-thread"),f.addEventListener("message",function(a){var b,c,d,f,g,h,i,j,l,m,n,o;if(!0!==a.data.status)return console.warn("Got an error!"),l=isNull(a.data.updateUser)?"Failed to create file":a.data.updateUser,stopLoadError(l,void 0,1e4),!1;if(!0!==a.data.done)return isNull(a.data.updateUser)?isNumber(a.data.progress)?($("#download-progress-indicator").exists()||(j='<paper-progress\n  class="transiting"\n  id="download-progress-indicator"\n  value="0"\n  max="1000">\n</paper-progress>\n<p>\n  <span class="bold">Estimated Time Remaining:</span> <span id="estimated-remaining-time">&#8734;</span>s\n</p>',$("#download-chooser .dialog-content .scrollable").append(j)),p$("#download-progress-indicator").value=a.data.progress,n=Date.now()-k,i=toFloat(a.data.progress)/1e3,o=n/i,_asm.progressTracking.estimate.push(o),b=_asm.progressTracking.estimate.mean(),g=b-n,$("#estimated-remaining-time").text(toInt(g/1e3))):console.log("Just an update",a.data):(console.log("Toasting: "+a.data.updateUser),toastStatusMessage(a.data.updateUser,1e3)),!1;d=a.data.csv;try{h=d.length/1024/1024}catch(a){h=0}return console.log("Downloadable size: "+h+" MiB"),null===_asm.sqlDumpLocation?(m='<div id="download-sql-summary" class="data-download-button">\n  <paper-spinner active></paper-spinner> Please wait while your SQL creation finishes ...\n</div>',(c=function(){return null===_asm.sqlDumpLocation?delay(250,function(){return c()}):(m=!1===_asm.sqlDumpLocation?'<a href="#" class="btn btn-danger data-download-button" id="download-sql-summary" disabled><iron-icon icon="icons:error"></iron-icon> SQL Creation Failed</a>':'<a href="'+_asm.sqlDumpLocation+'" download="asm-species-'+e+'.sql" class="btn btn-default data-download-button" id="download-sql-summary"><iron-icon icon="icons:file-download"></iron-icon> Download SQL</a>',$("#download-sql-summary").replaceWith(m)),!1})()):m=!1===_asm.sqlDumpLocation?'<a href="#" class="btn btn-danger data-download-button" id="download-sql-summary" disabled><iron-icon icon="icons:error"></iron-icon> SQL Creation Failed</a>':'<a href="'+_asm.sqlDumpLocation+'" download="asm-species-'+e+'.sql" class="btn btn-default data-download-button" id="download-sql-summary"><iron-icon icon="icons:file-download"></iron-icon> Download SQL</a>',j='<paper-dialog class="download-file" id="download-csv-file" modal>\n  <h2>Your files are ready</h2>\n  <paper-dialog-scrollable class="dialog-content">\n    <h3>Want to do data analysis?</h3>\n    <p>\n      We have an open API! Read all of our parameters here:\n      <a href="https://github.com/tigerhawkvok/asm-mammal-database/blob/master/README.md#api"  onclick=\'window.open(this.href); return false;\' onkeypress=\'window.open(this.href); return false;\'>README API Documentation <iron-icon icon="launch"></iron-icon></a>\n      <br/><br/>\n      We also have a UI to perform permission-restricted SQL queries on the database TODO\n    </p>\n    <h3>Which file type do I want?</h3>\n    <p>\n      A CSV file is readily opened by consumer-grade programs, such as Microsoft Excel or Google Spreadsheets.\n      It has some transformations done to the raw data to make it more readable.\n      <br/><br/>\n      However, if you wish to replicate the whole database and perform queries, the SQL file is machine-readable,\n      ready for import into a MySQL or MariaDB database by running the <code>source asm-species-'+e+'.sql;</code> in their\n      interactive shell prompts when run from your download directory. This file has not been transformed in any way.\n    </p>\n    <h3>Excel Important Note</h3>\n    <p>\n      Please note that some special characters in names may be decoded incorrectly by Microsoft Excel. If this is a problem, following the steps in <a href="https://github.com/tigerhawkvok/asm-mammal-database/blob/master/meta/excel_unicode_readme.md"  onclick=\'window.open(this.href); return false;\' onkeypress=\'window.open(this.href); return false;\'>this README <iron-icon icon="icons:launch"></iron-icon></a> to force Excel to format it correctly.\n    </p>\n    <p class="text-center">\n      <a href="'+d+'" download="asm-species-'+e+'.csv" class="btn btn-default data-download-button" id="download-csv-summary"><iron-icon icon="icons:file-download"></iron-icon> Download CSV</a>\n      '+m+'\n    </p>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',$("#download-csv-file").exists()?$("#download-csv-file").replaceWith(j):$("body").append(j),p$("#download-chooser").close(),h>=2?(console.debug("Large file size triggering blob creation"),downloadDataUriAsBlob("#download-csv-summary")):console.debug("File size is small enough to use a data-uri"),delay(250,function(){return safariDialogHelper("#download-csv-file")}),stopLoad(),f=Date.now()-k,console.debug("CSV time elapsed: "+f+"ms"),!1}),f.postMessage(d),!1}catch(d){return c=d,stopLoadError("There was a problem creating the CSV file. Please try again later."),console.error("Exception in downloadCSVList ) - "+c.message),console.warn(c.stack),console.warn("Got",a,"from",searchParams.apiPath+"?"+b,a.status)}}).fail(function(){return stopLoadError("There was a problem communicating with the server. Please try again later.")}),_asm.sqlDumpLocation=null,$.get(uri.urlString+"meta.php","action=get_db_dump","json").done(function(a){return!0===a.status?_asm.sqlDumpLocation=a.download_path:_asm.sqlDumpLocation=!1,!1}).fail(function(a,b){return!1}),!1},downloadHTMLList=function(){var a,b,c,d,e;startLoad(),e=Date.now(),_asm.progressTracking={estimate:[]};try{for(d=$("#download-chooser .buttons paper-button"),b=0,c=d.length;b<c;b++)a=d[b],p$(a).disabled=!0}catch(a){}return $.get(uri.urlString+"css/download-inline-bootstrap.css").done(function(a){var b,c,d,f,g,h,i;return d=new Date,b=d.getMonth()+1,i=1===(""+b).length?"0"+b:b,g=1===(""+d.getDate()).length?"0"+d.getDate():d.getDate(),f=d.getUTCFullYear()+"-"+i+"-"+g,h='<!doctype html>\n<html lang="en">\n  <head>\n    <title>ASM Species Checklist ver. '+f+'</title>\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta charset="UTF-8"/>\n    <meta name="theme-color" content="#445e14"/>\n    <meta name="viewport" content="width=device-width, initial-scale=1" />\n    <link href=\'http://fonts.googleapis.com/css?family=Droid+Serif:400,700,700italic,400italic|Roboto+Slab:400,700\' rel=\'stylesheet\' type=\'text/css\' />\n    <style type="text/css" id="asm-checklist-inline-stylesheet">\n      '+a+'\n    </style>\n  </head>\n  <body>\n    <div class="container-fluid">\n      <article>\n        <h1 class="text-center">ASM Species Checklist ver. '+f+"</h1>",c="q=*&order=linnean_order,linnean_family,genus,species,subspecies",$.get(""+searchParams.apiPath,c,"json").done(function(a){var b,c;return startLoad(),toastStatusMessage("Please be patient while we create the file for you"),b={action:"render-html",data:a,htmlHeader:h},c=new Worker("js/serviceWorker.min.js"),console.info("Rendering list off-thread"),c.addEventListener("message",function(a){var b,c,d,g,i,j,k,l,m,n,o;if(!0!==a.data.status)return console.warn("Got an error!"),l=isNull(a.data.updateUser)?"Failed to create file":a.data.updateUser,stopLoadError(l,void 0,1e4),!1;if(!0!==a.data.done)return isNull(a.data.updateUser)?isNumber(a.data.progress)?($("#download-progress-indicator").exists()||(k='<paper-progress\n  class="transiting"\n  id="download-progress-indicator"\n  value="0"\n  max="1000">\n</paper-progress>\n<p>\n  <span class="bold">Estimated Time Remaining:</span> <span id="estimated-remaining-time">&#8734;</span>s\n</p>',$("#download-chooser .dialog-content .scrollable").append(k)),p$("#download-progress-indicator").value=a.data.progress,n=Date.now()-e,j=toFloat(a.data.progress)/1e3,o=n/j,_asm.progressTracking.estimate.push(o),b=_asm.progressTracking.estimate.mean(),g=b-n,$("#estimated-remaining-time").text(toInt(g/1e3))):console.log("Just an update",a.data):(console.log("Toasting: "+a.data.updateUser),toastStatusMessage(a.data.updateUser,1e3)),!1;h=a.data.html,d="data:text/html;charset=utf-8,"+encodeURIComponent(h);try{i=d.length/1024/1024}catch(a){i=0}console.log("Downloadable size: "+i+" MiB"),c='<paper-dialog  modal class="download-file" id="download-html-file">\n  <h2>Your file is ready</h2>\n  <paper-dialog-scrollable class="dialog-content">\n    <p>\n      Please note that some taxa may have had incomplete data. Please download a CSV or SQL file for the uncombined taxon data.\n    </p>\n    <p class="text-center">\n      <a href="'+d+'" download="asm-species-'+f+'.html" class="btn btn-default data-download-button" id="download-html-summary"><iron-icon icon="icons:file-download"></iron-icon> Download HTML</a>\n      <div id="pdf-download-placeholder" class="data-download-button">\n        <paper-spinner active></paper-spinner> Please wait while your PDF creation finishes ...\n      </div>\n    </p>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Close</paper-button>\n  </div>\n</paper-dialog>',$("#download-html-file").exists()?$("#download-html-file").replaceWith(c):$("body").append(c),$("#download-chooser").on("iron-overlay-closed",function(){return delay(100,function(){return $(this).remove()})});try{p$("#download-chooser").close()}catch(a){}return i>=2?(console.debug("Large file size triggering blob creation"),downloadDataUriAsBlob("#download-html-summary")):console.debug("File size is small enough to use a data-uri"),safariDialogHelper("#download-html-file"),stopLoad(),toastStatusMessage("Please wait while we prepare your PDF file...","",7e3),m='<a href="#" disabled class="btn btn-danger" id="download-pdf-summary"><iron-icon icon="icons:error"></iron-icon> PDF Creation Failed</a>',console.debug("Posting for PDF"),$.post(uri.urlString+"pdf/pdfwrapper.php","html="+encodeURIComponent(h),"json").done(function(a){var b,c;return console.debug("PDF result",a),a.status?(c=""+uri.urlString+a.file,console.debug(c),b='<a href="'+c+'" download="asm-species-'+f+'.pdf" class="btn btn-default data-download-button" id="download-pdf-summary"><iron-icon icon="file-download"></iron-icon> Download PDF</a>',$("#download-html-file #download-html-summary").after(b)):(console.error("Couldn't make PDF file"),$("#download-html-file #download-html-summary").after(m))}).error(function(a,b){return console.error("Wasn't able to fetch PDF"),$("#download-html-file #download-html-summary").after(m)}).always(function(){var a;try{$("#download-html-file #pdf-download-placeholder").remove()}catch(a){}return a=Date.now()-e,console.debug("HTML+PDF time elapsed: "+a+"ms")}),!1}),c.postMessage(b),!1}).fail(function(){return stopLoadError("There was a problem communicating with the server. Please try again later.")})}).fail(function(){return stopLoadError("Unable to fetch styles for printout"),!1}),!1},showDownloadChooser=function(){var a;return a='<paper-dialog id="download-chooser" modal>\n  <h2>Select Download Type</h2>\n  <paper-dialog-scrollable class="dialog-content">\n    <p>\n      Once you select a file type, it will take a moment to prepare your download. Please be patient.\n    </p>\n  </paper-dialog-scrollable>\n  <div class="buttons">\n    <paper-button dialog-dismiss>Cancel</paper-button>\n    <paper-button id="initiate-csv-download">CSV/SQL</paper-button>\n    <paper-button id="initiate-html-download">HTML/PDF</paper-button>\n  </div>\n</paper-dialog>',$("#download-chooser").exists()||$("body").append(a),$("#initiate-csv-download").click(function(){return downloadCSVList()}),$("#initiate-html-download").click(function(){return downloadHTMLList()}),$("#download-chooser").on("iron-overlay-closed",function(){return delay(100,function(a){return function(){return $(a).remove()}}(this))}),safariDialogHelper("#download-chooser"),!1};
//# sourceMappingURL=download.min.js.map