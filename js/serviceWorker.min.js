function shuffle(a){for(var b,c,d=a.length;d;b=Math.floor(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a}var _asm,authorityTest,byteCount,commalessTest,createCSVFile,createHtmlFile,dateMonthToString,deEscape,decode64,delay,downloadCSVFile,encode64,generateCSVFromResults,getLocation,goTo,isArray,isBlank,isBool,isEmpty,isJson,isNull,isNumber,jsonTo64,locationData,markdown,openLink,openTab,post64,prepURI,progressStepCount,randomInt,randomString,renderDataArray,roundNumber,roundNumberSigfig,smartUpperCasing,toFloat,toInt,toObject,uri,validateAWebTaxon,window,indexOf=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1},modulo=function(a,b){return(+a%(b=+b)+b)%b};locationData={},locationData.params={enableHighAccuracy:!0},locationData.last=void 0,isBool=function(a,b){if(null==b&&(b=!1),b)return"boolean"==typeof a;try{return"boolean"==typeof a?!0===a||!1===a:"string"==typeof a?"true"===a.toLowerCase()||"false"===a.toLowerCase():"number"==typeof a&&(1===a||0===a)}catch(a){return a,!1}},isEmpty=function(a){return!a||0===a.length},isBlank=function(a){return!a||/^\s*$/.test(a)},isNull=function(a){try{if((isEmpty(a)||isBlank(a)||null==a)&&!1!==a&&0!==a)return!0}catch(a){return a,!1}return!1},isJson=function(a){if("object"==typeof a&&!isArray(a))return!0;try{return JSON.parse(a),!0}catch(a){return!1}return!1},isArray=function(a){var b;try{return b=a.slice(0),b.push("foo"),!0}catch(a){return!1}},isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},toFloat=function(a){return!isNumber(a)||isNull(a)?0:parseFloat(a)},toInt=function(a){var b;return!isNumber(a)||isNull(a)?0:(b=parseFloat(a),parseInt(b))},String.prototype.toAscii=function(){return this.replace(/[\u2018\u2019\u201A\u201B\u2032\u2035]/g,"'").replace(/[\u201C\u201D\u201E\u201F\u2033\u2036]/g,'"').replace(/[\u2013\u2014]/g,"-").replace(/[\u2026]/g,"...").replace(/\u02C6/g,"^").replace(/\u2039/g,"").replace(/[\u02DC|\u00A0]/g," ")},String.prototype.toBool=function(){var a;return"true"===(a=(""+this).toLowerCase())||"1"===a},Boolean.prototype.toBool=function(){return""+this=="true"},Number.prototype.toBool=function(){return""+this=="1"},String.prototype.addSlashes=function(){return this.replace(/[\\"']/g,"\\$&").replace(/\u0000/g,"\\0")},Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.containsObject=function(a){try{return"object"==typeof _.find(this,function(b){return _.isEqual(a,b)})}catch(a){return a,console.error("Please load underscore.js before using this."),console.info("https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js")}},Object.toArray=function(a){var b;try{return b=a.slice(0),b.push("foo"),a}catch(a){}return Object.keys(a).map(function(b){return function(b){return a[b]}}())},Object.size=function(a){var b,c,d;if("object"!=typeof a)try{return a.length}catch(a){b=a,console.error("Passed argument isn't an object and doesn't have a .length parameter"),console.warn(b.message)}d=0;for(c in a)a.hasOwnProperty(c)&&d++;return d},Object.doOnSortedKeys=function(a,b){var c,d,e,f,g,h;for(h=Object.keys(a).sort(),g=[],e=0,f=h.length;e<f;e++)d=h[e],c=a[d],g.push(b(c));return g},delay=function(a,b){return setTimeout(b,a)},roundNumber=function(a,b){var c;return null==b&&(b=0),c=Math.pow(10,b),Math.round(a*c)/c},roundNumberSigfig=function(a,b){var c,d,e,f,g;return null==b&&(b=0),e=""+roundNumber(a,b),c=e.split("."),1===c.length?e+"."+Array(b+1).join("0"):(g=c.pop(),f=c[0]+".",g.length===b?e:(d=b-g.length,g+=Array(d+1).join("0"),""+f+g))},String.prototype.stripHtml=function(a){var b;return null==a&&(a=!1),b=this,a&&(b=b.replace(/<(\w+)(?:[^"'>]|"[^"]*"|'[^']*')*>(?:((?:.)*?))<\/?\1(?:[^"'>]|"[^"]*"|'[^']*')*>/gm,"")),b=b.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,""),b=b.replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,"")},String.prototype.unescape=function(){return deEscape(this)},deEscape=function(a){var b,c,d;for(d=a,b=0;c!==d;){if(0!==b&&(d=c,a=c),a=a.replace(/\&amp;#/gim,"&#"),a=a.replace(/\&amp;/gim,"&"),a=a.replace(/\&quot;/gim,'"'),a=a.replace(/\&quote;/gm,'"'),a=a.replace(/\&#95;/gm,"_"),a=a.replace(/\&#39;/gm,"'"),a=a.replace(/\&#34;/gm,'"'),a=a.replace(/\&#62;/gm,">"),a=a.replace(/\&#60;/gm,"<"),++b>=10){console.warn("deEscape quitting after "+b+" iterations");break}c=a}return decodeURIComponent(a)},jsonTo64=function(a,b){var c,d,e;null==b&&(b=!0);try{e=a.slice(0),e.push("foo"),a=toObject(a)}catch(a){}return d=JSON.stringify(a),c=!0===b?post64(d):encode64(c)},encode64=function(a){try{return Base64.encode(a)}catch(b){return b,console.warn("Bad encode string provided"),a}},decode64=function(a){try{return Base64.decode(a)}catch(b){return b,console.warn("Bad decode string provided"),a}},post64=function(a){var b;return b=encode64(a),encodeURIComponent(b)},byteCount=function(a){return function(a){return encodeURI(a).split(/%..|./).length-1}}(),toObject=function(a){var b,c,d;d={};for(c in a)void 0!==(b=a[c])&&(d[c]=b);return d},String.prototype.toTitleCase=function(){var a,b,c,d,e,f,g,h,i,j,k;for(h=this.replace(/([^\W_]+[^\s-]*) */g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()}),f=["A","An","The","And","But","Or","For","Nor","As","At","By","For","From","In","Into","Near","Of","On","Onto","To","With"],a=0,b=f.length;a<b;a++)d=f[a],e=RegExp("\\s"+d+"\\s","g"),h=h.replace(e,function(a){return a.toLowerCase()});for(k=["Id","Tv"],g=0,c=k.length;g<c;g++)i=k[g],j=RegExp("\\b"+i+"\\b","g"),h=h.replace(j,i.toUpperCase());return h},smartUpperCasing=function(a){var b,c,d,e,f,g,h,i,j,k,l;if(isNull(a))return"";f=function(a){return a.replace(a,a.toUpperCase())},j=a.replace(/((?=((?!-)[\W\s\r\n]))\s[A-Za-z]|^[A-Za-z])/g,f),k=["a","an","and","at","but","by","for","in","nor","of","on","or","out","so","to","the","up","yet"];try{for(b=0,c=k.length;b<c;b++)l=k[b],g=l.toTitleCase(),e=l.toLowerCase(),d=RegExp(" "+g+" ","g"),j=j.replace(d," "+e+" ")}catch(a){}try{j.match(/([a-zA-Z]+ )*[a-zA-Z]+-([a-z]+)( [a-zA-Z]+)*/m)&&(h=j.replace(/([a-zA-Z]+ )*[a-zA-Z]+-([a-z]+)( [a-zA-Z]+)*/gm,"$2"),i=h.toTitleCase(),j=j.replace(h,i))}catch(a){}return j},Function.prototype.getName=function(){var a;return a=this.name,null==a&&(a=(""+this).substr(0,(""+this).indexOf("(")).replace("function ","")),isNull(a)&&(a=md5(""+this)),a},randomInt=function(a,b){var c,d,e;return null==a&&(a=0),null==b&&(b=1),e=Math.random(),null==a&&(c=[0,a],a=c[0],b=c[1]),a>b&&(d=[b,a],a=d[0],b=d[1]),Math.floor(e*(b-a+1)+a)},randomString=function(a){var b,c,d,e,f;for(null==a&&(a=8),e=0,c=65,d=126,f=[];e<a;)++e,b=randomInt(c,d),f.push(String.fromCharCode(b));return f.join("")},openLink=function(a){return null!=a&&(open(a),!1)},openTab=function(a){return openLink(a)},goTo=function(a){return null!=a&&(location.href=a,!1)},dateMonthToString=function(a){var b,c;b={0:"January",1:"February",2:"March",3:"April",4:"May",5:"June",6:"July",7:"August",8:"September",9:"October",10:"November",11:"December"};try{c=b[a]}catch(b){c=a}return c},prepURI=function(a){return a=encodeURIComponent(a),a.replace(/%20/g,"+")},locationData={},locationData.params={enableHighAccuracy:!0},locationData.last=void 0,getLocation=function(a){var b,c,d,e;return null==a&&(a=void 0),e=1500,c=function(b){var c;return clearTimeout(d),locationData.lat=b.coords.latitude,locationData.lng=b.coords.longitude,locationData.acc=b.coords.accuracy,c=locationData.last,locationData.last=Date.now(),!(locationData.last-c<e)&&(console.info("Successfully set location"),"function"==typeof a&&a(locationData),!1)},b=function(b){var c;return clearTimeout(d),c=function(){switch(b.code){case 0:return"There was an error while retrieving your location: "+b.message;case 1:return"The user prevented this page from retrieving a location";case 2:return"The browser was unable to determine your location: "+b.message;case 3:return"The browser timed out retrieving your location."}}(),console.error(c),"function"==typeof a&&a(!1),!1},navigator.geolocation?(console.log("Querying location"),navigator.geolocation.getCurrentPosition(c,b,locationData.params),d=delay(1500,function(){return getLocation(a)})):(console.warn("This browser doesn't support geolocation!"),null!=a?a(!1):void 0)},downloadCSVFile=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;if(t=Date.now(),u="",isJson(a)&&"string"==typeof a){console.info("Parsing as JSON string");try{m=JSON.parse(a)}catch(b){throw e=b,console.error("COuldn't parse json! "+e.message),console.warn(e.stack),console.info(a),"error"}}else if(isArray(a))console.info("Parsing as array"),m=toObject(a);else{if("object"!=typeof a)return console.error("Unexpected data type '"+typeof a+"' for downloadCSVFile()",a),!1;console.info("Parsing as object"),m=a}for(null==b&&(b={}),null==b.create&&(b.create=!1),null==b.downloadFile&&(b.downloadFile="datalist.csv"),null==b.classes&&(b.classes="btn btn-default"),null==b.buttonText&&(b.buttonText="Download File"),null==b.iconHtml&&(b.iconHtml='<iron-icon icon="icons:cloud-download"></iron-icon>'),null==b.selector&&(b.selector="#download-file"),null==b.splitValues&&(b.splitValues=!1),null==b.cascadeObjects&&(b.cascadeObjects=!1),null==b.objectAsValues&&(b.objectAsValues=!0),i=[],(q=function(c,d){var f,g,h,j,k,l,m,n,o,p,r,s;o=0,b.objectAsValues&&(b.splitValues="::@@::"),n=[];for(k in c)if("function"!=typeof(s=c[k])){++o;try{if(h=(""+k).replace(/"/g,'""'),1===o)if(b.objectAsValues){console.info("objectAsValues set");for(f in s)a=s[f],isArray(b.acceptableCols)?indexOf.call(b.acceptableCols,f)>=0&&i.push(f):i.push(f);console.log("Using as header",i)}else console.log("Boring options",b.objectAsValues,b),i.push(h);if("object"==typeof s&&d&&(s=q(s,!0)),j=function(a,c){var d,e,f,g;return null==a&&(a=s),null==c&&(c=b),isNull(s)?d="":("object"==typeof a&&(a=JSON.stringify(a)),a=""+a,e=a.replace(/,/g,","),e=e.replace(/"/g,'""'),e=e.replace(/<\/p><p>/g,'","'),"string"==typeof c.splitValues&&(f=e.split(c.splitValues),e=f.join('","'),h=!1),d=e),!1===h?g='"'+d+'"\n':isNumber(h)?g='"'+d+'",':isNull(h)||(g='"'+h+'","'+d+'"\n'),g},b.objectAsValues){for(p=[],l=0,m=i.length;l<m;l++){if(f=i[l],"object"==typeof(g=s[f]))try{g=JSON.stringify(g),g=g.replace(/"/g,'""')}catch(a){}p.push(g)}r=p.join(b.splitValues),n.push(u+=j(r,b))}else n.push(u+=j(s))}catch(a){e=a,console.warn("Unable to run key "+k+" on row "+o,s,c),n.push(console.warn(e.stack))}}return n})(m,b.cascadeObjects),u=u.trim(),n=0,o=0,p=i.length;o<p;o++)d=i[o],d=d.replace(/"/g,'""'),i[n]=d,++n;return b.objectAsValues&&(b.header=i),isArray(b.header)?(j=b.header.join('","'),u='"'+j+'"\n'+u,u=u.trim(),h="present"):h="absent",","===u.slice(-1)&&(u=u.slice(0,-1)),g="data:text/csv;charset=utf-8;header="+h+","+encodeURIComponent(u),s=b.selector,!0===b.create?(c=randomInt(0,9999),l=s.slice(1)+"-download-button-"+c,k='<a id="'+l+'" class="'+b.classes+'" href="'+g+'" download="'+b.downloadFile+'">\n  '+b.iconHtml+"\n  "+b.buttonText+"\n</a>"):k="",r={file:g,options:b,html:k},f=Date.now()-t,console.debug("CSV Worker saved "+f+"ms from main thread"),r},generateCSVFromResults=function(a,b,c){var d,e;null==c&&(c="#modal-sql-details-list"),console.info("Worker CSV: Given",a),d={objectAsValues:!0,downloadFile:"adp-global-search-result-data_"+Date.now()+".csv"};try{e=downloadCSVFile(a,d)}catch(a){console.error("Sorry, there was a problem with this dataset and we can't do that right now."),e={file:"",options:d,html:""}}return e},validateAWebTaxon=function(a,b){var c,d,e;return null==b&&(b=null),null==(void 0!==e&&null!==e?e.validatedTaxons:void 0)&&("object"!=typeof e&&(e={}),e.validatedTaxons=[]),d=function(a){return"function"==typeof b&&b(a),!1},e.validatedTaxons.containsObject(a)?(console.info("Already validated taxon, skipping revalidation",a),d(a),!1):(c="action=validate&genus="+a.genus+"&species="+a.species,null!=a.subspecies&&(c+="&subspecies="+a.subspecies),_adp.currentAsyncJqxhr=$.post("api.php",c,"json").done(function(b){return b.status?(a.genus=b.validated_taxon.genus,a.species=b.validated_taxon.species,a.subspecies=b.validated_taxon.subspecies,null==a.clade&&(a.clade=b.validated_taxon.family),e.validatedTaxons.push(a)):a.invalid=!0,a.response=b,d(a),!1}).fail(function(b,c){var d;return d=a.genus+" "+a.species,d=null!=a.subspecies?d+" "+a.subspecies:d,bsAlert("<strong>Problem validating taxon:</strong> "+d+" couldn't be validated."),console.warn("Warning: Couldn't validated "+d+" with AmphibiaWeb")}),!1)},authorityTest=/^\(? *((['"])? *([\w\u00C0-\u017F\. \-\&;\[\]]+(,|&|&amp;|&amp;amp;|&#[\w0-9]+;)?)+ *\2) *, *([0-9]{4}) *\)?/gim,commalessTest=/^(\(?)(.*?[^,]) ([0-9]{4})(\)?)$/gim,progressStepCount=1e3,"object"!=typeof uri&&(uri={urlString:""}),"object"!=typeof _asm&&(_asm={affiliateQueryUrl:{iucnRedlist:"http://apiv3.iucnredlist.org/api/v3/species/common_names/"}}),self.addEventListener("message",function(a){var b,c,d,e;switch(a.data.action){case"render-row":return c=a.data.data,b=isNumber(a.data.chunk)?toInt(a.data.chunk):100,d=null!=(e=a.data.firstIteration.toBool())&&e,renderDataArray(c,d,b);case"render-html":return console.log("Got HTML info from file on thread",a.data),createHtmlFile(a.data.data,a.data.htmlHeader);case"render-csv":return console.log("Got CSV info from file on thread",a.data),createCSVFile(a.data.data);default:return console.error("No valid action recieved from worker initialization!",a.data),console.warn(a)}}),window={},self.importScripts("markdown.min.js"),self.importScripts("markdown.min.js"),markdown=window.markdown,renderDataArray=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D;for(null==a&&(a=dataArray),null==b&&(b=!0),null==c&&(c=100),l="",[],B="cndb-result-list",n="<table id='"+B+"' class='table table-striped table-hover col-md-12'>\n\t<tr class='cndb-row-headers'>",m="</table>",d=0,isNumber(c)||(c=100),j=a.length<=c,p=0,console.log("Starting loop with i = "+p+", renderChunk = "+c+", data length = "+a.length,b,j),t=0,u=a.length;t<u;t++){if(x=a[t],p,0===toInt(p)&&b){q=0,n+="\n\x3c!-- Table Headers - "+Object.size(x)+" entries --\x3e";for(r in x)x[r],w=r.replace(/_/g," "),w=function(){switch(w){case"simple linnean subgroup":return"Group";case"major subtype":return"Clade";default:return w}}(),n+="\n\t\t<th class='text-center'>"+w+"</th>",d++,q++;n+="\n\t</tr>",n+="\n\x3c!-- End Table Headers --\x3e",console.log("Got "+d+" display columns."),e=roundNumber(12/d,0),g="col-md-"+e,l=n}C=x.genus+"+"+x.species,isNull(x.subspecies)||(C=C+"+"+x.subspecies),y="msadb-row"+p,o="\n\t<tr id='"+y+"' class='cndb-result-entry' data-taxon=\""+C+'" data-genus="'+x.genus+'" data-species="'+x.species+'">';for(r in x){if(f=x[r],"authority_year"===r)if(isNull(f))h=f;else{try{h=JSON.parse(f)}catch(a){i=a;try{console.warn("There was an error parsing authority_year='"+f+"', attempting to fix - ",i.message),A=f.split(":"),D=A[1].slice(A[1].search('"')+1,-2),D=D.replace(/"/g,"'"),A[1]='"'+D+'"}',f=A.join(":"),h=JSON.parse(f)}catch(a){i=a,console.error("There was an error parsing '"+f+"'",i.message),h=f}}try{k=Object.keys(h)[0],z=h[k],toInt(x.parens_auth_genus).toBool()&&(k="("+k+")"),toInt(x.parens_auth_species).toBool()&&(z="("+z+")"),f="G: "+k+"<br/>S: "+z}catch(a){}}"image"===r&&(f=isNull(f)?"<paper-icon-button icon='launch' data-href='"+_asm.affiliateQueryUrl.mammalPhotos+"?rel-taxon=contains&where-taxon="+C+"' class='newwindow calphoto click' data-taxon=\""+C+'"></paper-icon-button>':"<paper-icon-button icon='image:image' data-lightbox='"+uri.urlString+f+"' class='lightboximage'></paper-icon-button>"),s="genus"!==r&&"species"!==r&&"subspecies"!==r?r+" text-center":r,"genus_authority"===r||"species_authority"===r?s+=" authority":"common_name"===r&&(f=smartUpperCasing(f),s+=" no-cap"),o+="\n\t\t<td id='"+r+"-"+p+"' class='"+s+" "+g+"'>"+f+"</td>"}if(o+="\n\t</tr>",l+=o,++p>=c)break}return console.log("Ended data loop with i = "+p+", renderChunk = "+c),b&&(l+=m),v={html:l,nextChunk:a.slice(p),renderChunk:c,loops:p},self.postMessage(v),self.close()},createHtmlFile=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G;C=Date.now(),console.debug("Got",a),console.debug("Got body provided?",!isNull(b)),E=a.count,s=E/progressStepCount,console.debug("Step size",s);try{if(!0!==a.status)throw Error("Invalid Result");l=[],k=[],m=[],t=a.result;for(p in t){x=t[p];try{p>0&&(0===toInt(modulo(p,s))&&(q={status:!0,done:!1,progress:toInt(p/s)},self.postMessage(q)),0===modulo(p,100)&&0===modulo(p,500)&&(q={status:!0,done:!1,updateUser:"Parsing "+p+" of "+E+", please wait"},self.postMessage(q)))}catch(a){}if(!isNull(x.genus)&&!isNull(x.species)){try{clearTimeout(j),j=delay(250,function(){return console.warn("Possible hang on row #"+p,x),j=delay(1e3,function(){return q={status:!1,done:!1,updateUser:"Failure to parse row "+p},self.postMessage(q),self.close()})})}catch(a){}try{if("object"!=typeof x.authority_year){c={};try{isNumber(x.authority_year)?c[x.authority_year]=x.authority_year:isNull(x.authority_year)?(x.species_authority=x.species_authority.replace(/(<\/|<|&lt;|&lt;\/).*?(>|&gt;)/gim,""),commalessTest.test(x.species_authority)&&(x.species_authority=x.species_authority.replace(commalessTest,"$1$2, $3$4")),authorityTest.test(x.species_authority)?(G=x.species_authority.replace(authorityTest,"$5"),x.species_authority=x.species_authority.replace(authorityTest,"$1"),c[G]=G,x.authority_year=c):(isNull(x.species_authority)||console.warn("Failed a match on authority '"+x.species_authority+"'"),c.Unknown="Unknown")):c=JSON.parse(x.authority_year)}catch(a){f=a,console.debug("authority isnt number, null, or object, with bad species_authority '"+x.authority_year+"'"),B=x.authority_year.split(":"),B.length>1?(G=B[1].slice(B[1].search('"')+1,-2),G=G.replace(/"/g,"'"),B[1]='"'+G+'"}',c=JSON.parse(B.join(":"))):(console.warn("Unable to figure out the type of data for `authority_year`: "+f.message,JSON.stringify(x)),console.warn(f.stack))}}else c=x.authority_year;try{i=Object.keys(c)[0],A=c[i],i=i.replace(/&#39;/g,"'"),A=A.replace(/&#39;/g,"'")}catch(a){for(d in c)F=c[d],i=d.replace(/&#39;/g,"'"),A=F.replace(/&#39;/g,"'")}isNull(x.genus_authority)?x.genus_authority=x.species_authority:isNull(x.species_authority)&&(x.species_authority=x.genus_authority),h=x.genus_authority.toTitleCase()+" "+i,toInt(x.parens_auth_genus).toBool()&&(h="("+h+")"),z=x.species_authority.toTitleCase()+" "+A,toInt(x.parens_auth_species).toBool()&&(z="("+z+")")}catch(a){f=a,console.warn("There was a problem parsing the authority information for _"+x.genus+" "+x.species+" "+x.subspecies+"_ - "+f.message),console.warn(f.stack),console.warn("Bad parse for authority year -- tried to fix >>"+x.authority_year+"<<",c,x.authority_year),console.warn("We were working with",c,i,h,A,z)}if(isNull(x.entry))o="";else try{o=markdown.toHTML(x.entry)}catch(a){f=a,console.warn("Unable to parse Markdown for _"+x.genus+" "+x.species+" "+x.subspecies+"_"),o=x.entry}n="",isNull(o)||isNull(x.taxon_credit)||(D="",isNull(x.taxon_credit_date)||(D=", "+x.taxon_credit_date),n='<p class="text-right small text-muted">\n  <cite>\n    '+x.taxon_credit+D+"\n  </cite>\n</p>"),r="",u=x.linnean_order.trim(),indexOf.call(k,u)<0&&(r+='<h2 class="clade-declaration text-capitalize text-center">'+x.linnean_order+"</h2>",k.push(x.linnean_order.trim())),v=x.linnean_family.trim(),indexOf.call(m,v)<0&&(r+='<h3 class="subclade-declaration text-capitalize text-center">'+x.linnean_family+"</h3>",m.push(x.linnean_family.trim())),w=x.genus,indexOf.call(l,w)<0&&(r+='<aside class="genus-declaration lead">\n  <span class="entry-sciname text-capitalize">'+x.genus+'</span>\n  <span class="entry-authority">'+h.unescape()+"</span>\n</aside>",l.push(x.genus)),y=x.genus.slice(0,1)+". ",g='<section class="species-entry">\n  '+r+'\n  <p class="h4 entry-header">\n    <span class="entry-sciname">\n      <span class="text-capitalize">'+y+"</span> "+x.species+" "+x.subspecies+'\n    </span>\n    <span class="entry-authority">\n      '+z.unescape()+'\n    </span>\n    &#8212;\n    <span class="common_name no-cap">\n      '+smartUpperCasing(x.common_name)+'\n    </span>\n  </p>\n  <div class="entry-content">\n    '+o+"\n    "+n+"\n  </div>\n</section>",b+=g}}return b+="</article>\n</div>\n</body>\n</html>",q={status:!0,done:!1,progress:progressStepCount},self.postMessage(q),e=Date.now()-C,console.log("HTML file prepped in "+e+"ms off-thread"),q={html:b,status:!0,done:!0},self.postMessage(q),console.debug("Completed worker!"),self.close()}catch(a){return f=a,console.error("There was a problem creating your file. Please try again later."),console.error("Exception in createHtmlFile() - "+f.message),console.warn(f.stack),q={status:!1,done:!0},self.postMessage(q),self.close()}},createCSVFile=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H;D=Date.now(),h="  ",i=[],A=["genus","species","subspecies","canonical_sciname","common_name","common_name_source","image","image_caption","image_credit","image_license","major_type","major_subtype","simple_linnean_group","simple_linnean_subgroup","linnean_order","linnean_family","genus_authority","species_authority","deprecated_scientific","notes","entry","taxon_credit","taxon_credit_date","taxon_author","citation","source","internal_id"],v=["genus","common_name","taxon_credit","linnean_order","linnean_family","genus_authority","species_authority"],c=["parens_auth_genus","parens_auth_species"],r=0,console.debug("Got result"),F=Object.size(a.result),x=F/progressStepCount,console.debug("Step size",x);try{y=a.result;for(s in y)if(z=y[s],s>0&&(0===toInt(modulo(s,x))&&(w={status:!0,done:!1,progress:toInt(s/x)},self.postMessage(w)),0===modulo(s,100)&&(console.debug("CSV-ing row "+s+" of "+F),0===modulo(s,500)&&(w={status:!0,done:!1,updateUser:"Parsing "+s+" of "+F+", please wait"},self.postMessage(w)))),k=[],!isNull(z.genus)&&!isNull(z.species)){for(t=0,u=A.length;t<u;t++){l=A[t],m=z[l],e=l.replace(/"/g,'""');try{f=m.replace(/"/g,'""').replace(/&#39;/g,"'")}catch(a){f=""}if(0===r&&indexOf.call(A,e)>=0&&i.push(e.replace(/_/g," ").toTitleCase()),indexOf.call(A,e)>=0){if(/[a-z]+_authority/.test(e)){f=f.unescape();try{if("object"!=typeof z.authority_year){b={};try{isNumber(z.authority_year)?b[z.authority_year]=z.authority_year:isNull(z.authority_year)?(z.species_authority=z.species_authority.replace(/(<\/|<|&lt;|&lt;\/).*?(>|&gt;)/gim,""),commalessTest.test(z.species_authority)&&(z.species_authority=z.species_authority.replace(commalessTest,"$1$2, $3$4")),authorityTest.test(z.species_authority)?(H=z.species_authority.replace(authorityTest,"$5"),z.species_authority=z.species_authority.replace(authorityTest,"$1"),b[H]=H,z.authority_year=b):(isNull(z.species_authority)||console.warn("Failed a match on authority '"+z.species_authority+"'"),b.Unknown="Unknown")):b=JSON.parse(z.authority_year)}catch(a){p=a,console.debug("authority isnt number, null, or object, with bad species_authority '"+z.authority_year+"'"),C=z.authority_year.split(":"),C.length>1?(H=C[1].slice(C[1].search('"')+1,-2),H=H.replace(/"/g,"'"),C[1]='"'+H+'"}',b=JSON.parse(C.join(":"))):(console.warn("Unable to figure out the type of data for `authority_year`: "+p.message,JSON.stringify(z)),console.warn(p.stack))}}else b=z.authority_year;"string"==typeof z.authority_year&&(z.authority_year=z.authority_year.trim()),isNull(z.authority_year)&&(z.authority_year=JSON.stringify(b));try{q=Object.keys(b)[0],B=b[q],q=q.replace(/&#39;/g,"'"),B=B.replace(/&#39;/g,"'")}catch(a){for(d in b)G=b[d],q=d.replace(/&#39;/g,"'"),B=G.replace(/&#39;/g,"'")}if(isNull(z.genus_authority)?z.genus_authority=z.species_authority+" [assumed]":isNull(z.species_authority)&&(z.species_authority=z.genus_authority),isNull(f)){try{f=z[l].unescape()}catch(a){}(isNull(f)||"[assumed]"===f.trim())&&(f="Unknown")}switch(e.split("_")[0]){case"genus":E=f.toTitleCase()+", "+q,toInt(z.parens_auth_genus).toBool()&&(E="("+E+")");break;case"species":E=f.toTitleCase()+", "+B,toInt(z.parens_auth_species).toBool()&&(E="("+E+")")}f=E}catch(a){p=a}}if("authority_year"===l)if(isNull(f&&!isNull(z[l])))try{f=z[l],"object"==typeof f&&(f=JSON.stringify(f).replace(/"/g,'""'))}catch(a){}else console.debug("auth year '"+f+"' is valid",isNull(f,!isNull(z[l],e,l)));if("deprecated_scientific"===l&&"object"==typeof f&&(f=JSON.stringify(f)),indexOf.call(v,e)>=0&&(f=f.toTitleCase()),"image"!==e||isNull(f)||(f=""+uri.urlString+f),indexOf.call(c,e)>=0)try{f=""+f.toBool()}catch(a){}k.push('"'+f+'"')}}r++,j=k.join(","),h+="\n"+j}return g=i.join(",")+"\n"+h,n="data:text/csv;charset=utf-8,"+encodeURIComponent(g),w={status:!0,done:!1,progress:progressStepCount},self.postMessage(w),o=Date.now()-D,console.log("CSV file prepped in "+o+"ms off-thread"),w={csv:n,status:!0,done:!0},self.postMessage(w),console.debug("Completed worker!"),self.close()}catch(a){return p=a,console.error("There was a problem creating your file. Please try again later."),console.error("Exception in createCSVFile() - "+p.message),console.warn(p.stack),w={status:!1,done:!0},self.postMessage(w),self.close()}};
//# sourceMappingURL=serviceWorker.min.js.map